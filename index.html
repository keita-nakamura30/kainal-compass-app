<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAINAL Compass</title>
    
    <!-- PWA設定 -->
    <meta name="theme-color" content="#1976d2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="KAINAL Compass">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            line-height: 1.6;
            color: #333;
            min-height: 100vh;
        }

        /* ログイン画面 */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 50%, #81c784 100%);
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .login-logo {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 32px;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            background: #fafafa;
        }

        .form-input:focus {
            outline: none;
            border-color: #1976d2;
            background: white;
            box-shadow: 0 0 0 3px rgba(25,118,210,0.1);
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(25,118,210,0.3);
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 12px;
        }

        /* ヘッダー */
        .header {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 20px rgba(25,118,210,0.3);
            position: relative;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* .logo-circle スタイルを削除し、admin-badgeを調整 */
.admin-badge {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,193,7,0.9);
    color: #333;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: bold;
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    gap: 4px;
}

        .admin-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,193,7,0.9);
            color: #333;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .user-info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }

        /* メインコンテンツ */
        .main-content {
    max-width: 500px;
    margin: 0 auto;
    padding: 24px;
    padding-bottom: 120px; /* 100px から 120px に増加 */
}

        /* ページヘッダー（お気に入りページなど） */
        .page-header {
            background: white;
            padding: 20px;
            margin: -24px -24px 24px -24px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-to-home-btn {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(25,118,210,0.3);
        }

        .back-to-home-btn:hover {
            transform: scale(1.1);
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
            flex: 1;
        }

        /* 管理者専用セクション */
        .admin-section {
            background: rgba(255,193,7,0.1);
            border: 2px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 12px;
            text-align: center;
        }

        .admin-section h4 {
            color: #f57c00;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .admin-section p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .admin-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .admin-btn {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-btn:hover {
            background: #f57c00;
            color: white;
            transform: translateY(-2px);
        }

        /* ホーム画面の記事カード */
        .article-card {
            background: white;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }

        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

.article-image {
    width: 100%;
    height: 220px;
    background-size: cover;
    background-position: center;
    position: relative;
}

        .article-info {
            padding: 20px;
        }

        .article-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1976d2;
        }

        .article-date {
            color: #666;
            font-size: 14px;
        }

        .card-favorite-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255,255,255,0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .card-favorite-btn:hover {
            transform: scale(1.1);
        }

        .card-favorite-btn.active {
            background: rgba(255,152,0,0.9);
            color: white;
        }

        .admin-edit-btn {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(255,193,7,0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            color: #333;
        }

        .admin-edit-btn:hover {
            transform: scale(1.1);
            background: #f57c00;
            color: white;
        }

        /* 記事詳細画面 */
        .article-detail {
            background: white;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .detail-header {
            position: relative;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .back-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            margin-bottom: 12px;
            color: #1976d2;
            transition: color 0.3s;
        }

        .back-button:hover {
            color: #42a5f5;
        }

        .detail-date {
            font-size: 18px;
            color: #1976d2;
            font-weight: 600;
        }

        .detail-image {
            width: 100%;
            height: 280px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .play-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 70px;
            height: 70px;
            background: rgba(25,118,210,0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .play-button:hover {
            background: rgba(25,118,210,1);
            transform: scale(1.1);
        }

        .favorite-star {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .favorite-star:hover {
            transform: scale(1.1);
        }

        .favorite-star.active {
            background: rgba(255,152,0,0.9);
            color: white;
        }

        .detail-content {
            padding: 32px;
        }

        .detail-title {
            font-size: 26px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1976d2;
        }

        .detail-subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 32px;
        }

        /* 音声プレーヤー */
        .audio-player {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 24px;
            margin: 24px 0;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(25,118,210,0.3);
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .player-btn {
            width: 56px;
            height: 56px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .player-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .time-display {
            font-family: monospace;
            font-size: 16px;
            color: white;
            margin-left: auto;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

.progress-bar {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 4px;
        }

        /* 音声再生速度コントロール */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 16px;
        }

        .speed-label {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
            margin-right: 4px;
        }

        .speed-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            min-width: 40px;
        }

        .speed-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .speed-btn.active {
            background: white;
            color: #1976d2;
            font-weight: bold;
        }

        .detail-text {
            font-size: 16px;
            line-height: 1.8;
            color: #444;
            margin-bottom: 40px;
        }

        /* 今日のまとめ */
        .summary-section {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 24px;
            margin: 32px 0;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(25,118,210,0.3);
        }

        .summary-title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }

        .summary-item {
            background: rgba(255,255,255,0.1);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.6;
            backdrop-filter: blur(10px);
        }

        .summary-item:last-child {
            margin-bottom: 0;
        }

        /* お気に入り追加 */
        .favorite-section {
            text-align: center;
            margin: 40px 0;
        }

        .favorite-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #ccc;
            transition: all 0.3s;
        }

        .favorite-btn.active {
            color: #ff9800;
            transform: scale(1.2);
        }

        .favorite-text {
            margin-left: 12px;
            color: #666;
            font-size: 16px;
        }

        /* 評価セクション */
        .rating-section {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 32px;
            margin: 32px 0;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(25,118,210,0.3);
        }

        .rating-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 24px;
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .star {
            font-size: 36px;
            color: rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.2s;
        }

        .star.active {
            color: #ff9800;
            transform: scale(1.1);
        }

        .star:hover {
            transform: scale(1.2);
        }

        .feedback-input {
            width: 100%;
            min-height: 100px;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            resize: vertical;
            margin-bottom: 20px;
            font-family: inherit;
        }

        .submit-btn {
            background: white;
            color: #1976d2;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
        }

        .navigation-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-size: 15px;
            display: flex;
            align-items: center;
            transition: opacity 0.3s;
        }

        .nav-link:hover {
            opacity: 0.8;
        }

        /* お気に入りページのカード */
        .favorite-card {
            background: white;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .favorite-card:hover {
            transform: translateY(-3px);
        }

        .favorite-card-content {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .favorite-card-image {
            width: 80px;
            height: 80px;
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .favorite-card-info {
            flex: 1;
        }

        .favorite-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 4px;
        }

        .favorite-card-date {
            color: #666;
            font-size: 12px;
        }

        .remove-favorite-btn {
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .remove-favorite-btn:hover {
            background: rgba(255,107,107,0.1);
        }

        /* 管理者ダッシュボード */
        .admin-dashboard {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .admin-dashboard h3 {
            color: #f57c00;
            margin-bottom: 20px;
            text-align: center;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffc107, #f57c00);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* 底部ナビゲーション */
        /* 底部ナビゲーション */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid #e3f2fd;
    display: flex;
    justify-content: center;
    gap: 60px;
    padding: 16px 0;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
    z-index: 2000;
}

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #999;
            font-size: 12px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-item.active {
            color: #1976d2;
            transform: scale(1.05);
        }

        .nav-icon {
            font-size: 26px;
            margin-bottom: 4px;
        }

        /* ユーティリティ */
        .hidden {
            display: none !important;
            visibility: hidden !important;
        }

        .admin-only {
            display: none;
        }

        .admin-mode .admin-only {
            display: block;
        }

        .empty-message {
            text-align: center;
            color: #666;
            margin-top: 60px;
            padding: 40px 20px;
        }

        .empty-message-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* 会員管理カード */
        .member-card {
            background: white;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s;
            animation: fadeIn 0.6s ease-out;
        }

        .member-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .member-card-header {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .member-email {
            font-size: 14px;
            opacity: 0.9;
        }

        .member-role {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .member-role.admin {
            background: #ffc107;
            color: #333;
        }

        .member-actions {
            padding: 16px 20px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .edit-btn {
            background: #2196f3;
            color: white;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }

.action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* テンプレート管理ページ */
        .template-admin-section {
            background: rgba(255,193,7,0.1);
            border: 2px solid #ffc107;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .template-admin-section h4 {
            color: #f57c00;
            margin-bottom: 16px;
            font-size: 18px;
        }

.template-add-section {
            text-align: center;
            margin-bottom: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

.template-add-btn {
            background: linear-gradient(135deg, #42a5f5, #1976d2);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(66,165,245,0.3);
            min-width: 200px;
            justify-content: center;
        }

        .template-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66,165,245,0.4);
        }

        .add-icon {
            font-size: 18px;
        }

        /* カテゴリフィルター */
        .category-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding: 4px;
        }

        .category-btn {
            background: white;
            border: 2px solid #e3f2fd;
            color: #666;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .category-btn:hover {
            border-color: #42a5f5;
            color: #42a5f5;
        }

        .category-btn.active {
            background: #42a5f5;
            border-color: #42a5f5;
            color: white;
        }

        /* テンプレートグリッド */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .template-item {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .template-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .template-thumbnail {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            position: relative;
        }

        .template-info {
            padding: 16px;
        }

        .template-title {
            font-size: 16px;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .template-category {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .template-memo {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .template-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .template-action-btn {
            background: none;
            border: none;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 16px;
        }

        .template-action-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        .edit-template-btn {
            color: #42a5f5;
        }

        .delete-template-btn {
            color: #f44336;
        }

        /* 空の状態 */
        .empty-templates {
    text-align: center;
    padding: 40px 20px 60px 20px; /* 上下のpadding調整 */
    color: #666;
    margin-bottom: 40px; /* 底部ナビゲーションとの間隔を確保 */
}

        .empty-icon {
            font-size: 72px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-templates h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #1976d2;
        }

        .empty-templates p {
            font-size: 16px;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        /* モーダルスタイル */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal input, .modal textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 2px solid #e3f2fd;
            border-radius: 8px;
            font-size: 16px;
        }

        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        /* ID発行結果表示 */
        .id-result {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            padding: 24px;
            border-radius: 16px;
            margin: 20px 0;
            text-align: center;
        }

        .id-result h4 {
            margin-bottom: 16px;
            font-size: 18px;
        }

        .id-info {
            background: rgba(255,255,255,0.2);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-family: monospace;
            font-size: 16px;
        }

        .copy-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* 画像プレビュー */
        .image-preview {
            text-align: center;
            margin-bottom: 16px;
        }

        .preview-image {
            width: 200px;
            height: 120px;
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin: 0 auto 8px auto;
            border: 2px solid #e3f2fd;
        }

        .refresh-image-btn {
            background: #42a5f5;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-image-btn:hover {
            background: #1976d2;
        }

        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .article-card, .favorite-card, .member-card {
            animation: fadeIn 0.6s ease-out;
        }

/* レスポンシブ */
        @media (max-width: 768px) {
    .main-content {
        padding: 20px;
        padding-bottom: 140px; /* モバイルでは更に余裕を持たせる */
    }
    .header {
        padding: 16px 0;
        position: relative;
    }
    
    .user-info {
        font-size: 12px;
        top: 16px;
        left: 16px;
    }
    
    .logo {
        font-size: 22px;
        padding: 0 60px;
    }
    
    .admin-badge {
        top: 16px;
        right: 16px;
        font-size: 10px;
        padding: 4px 8px;
        border-radius: 12px;
    }
    
    .header .user-info,
    .header .admin-badge {
        max-width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
            
            .detail-content {
                padding: 24px;
            }
            
            .bottom-nav {
                gap: 40px;
            }

            .admin-controls {
                flex-direction: column;
            }

            .player-controls {
                flex-wrap: wrap;
                gap: 12px;
            }
            
            .speed-control {
                order: 3;
                width: 100%;
                justify-content: center;
                margin: 8px 0 0 0;
            }

            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                padding: 20px;
                margin: 20px;
            }

            .page-header {
                margin: -20px -20px 20px -20px;
            }

            /* スマートフォン表示問題を完全に修正 */
body::before,
body::after,
*::before,
*::after {
    display: none !important;
    visibility: hidden !important;
    content: none !important;
}

.login-container {
    padding-top: 60px !important;
    position: relative !important;
    z-index: 1000 !important;
}

.template-add-section {
    display: none !important;
    visibility: hidden !important;
}

/* 上部の不要なテキスト表示を強制非表示 */
body > *:first-child:not(.login-container):not(#loginScreen):not(#mainApp) {
    display: none !important;
}

        /* テンプレートカードのホバー効果 */
        .template-thumbnail {
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .open-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(66,165,245,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            color: white;
        }

        .template-thumbnail:hover .open-overlay {
            opacity: 1;
        }

        .open-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .open-text {
            font-size: 14px;
            font-weight: 600;
        }

        /* クイックアクションボタン */
        .template-quick-actions {
            display: flex;
            gap: 8px;
            margin: 12px 0;
        }

        .quick-open-btn {
            flex: 1;
            background: linear-gradient(135deg, #42a5f5, #1976d2);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .quick-open-btn:hover {
            transform: translateY(-2px);
        }

        .copy-url-btn {
            background: #f5f5f5;
            color: #666;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

.copy-url-btn:hover {
    background: #e3f2fd;
    color: #1976d2;
}

/* 新しく追加されるCSS */
.template-thumbnail img {
    transition: transform 0.3s ease, opacity 0.3s ease;
}

.template-thumbnail:hover img {
    transform: scale(1.05);
}

.template-thumbnail {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    background-size: cover;
    background-position: center;
}

.template-thumbnail::before {
    content: "🖼️";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    opacity: 0.3;
    z-index: 0;
}
</style>
</head>

<body>
    <!-- ログイン画面 -->
    <div id="loginScreen" class="login-container">
        <form class="login-form" id="loginForm">
            <div class="login-logo">🧭 KAINAL Compass</div>
            <div class="login-subtitle">海のように深い学びを、音声で</div>
            
            <div class="form-group">
                <label class="form-label">ログインID</label>
                <input type="text" class="form-input" id="userId" placeholder="ログインIDを入力" required>
                <label class="form-label">メールアドレス</label>
                <input type="email" class="form-input" id="userEmail" placeholder="メールアドレスを入力" required>
            </div>
            <button type="button" class="login-btn" onclick="doLogin()">ログイン</button>
            <div id="errorMessage" class="error-message hidden"></div>
        </form>
    </div>

    <!-- メインアプリ -->
    <div id="mainApp" class="hidden">
        <!-- ヘッダー -->
        <header class="header">
    <div class="user-info" id="userInfo">ようこそ</div>
    <div class="logo">KAINAL Compass</div>
    <div class="admin-badge admin-only">🧭 管理者</div>
</header>

        <!-- ホーム画面 -->
        <div id="homeScreen" class="main-content">
            <!-- 管理者ダッシュボード -->
            <div class="admin-dashboard admin-only">
                <h3>📊 管理者ダッシュボード</h3>
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number">0</div>
                        <div class="stat-label">投稿記事数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="memberCount">1</div>
                        <div class="stat-label">会員数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">87</div>
                        <div class="stat-label">総再生回数</div>
                    </div>
                </div>
            </div>

            <!-- 管理者専用セクション -->
            <div class="admin-section admin-only">
                <h4>🎫 ID発行・会員管理</h4>
                <p>新規会員のIDを発行したり、既存会員を管理できます</p>
                <div class="admin-controls">
                    <button class="admin-btn" onclick="showIdIssueForm()" style="background: #4caf50;">🎫 ID発行</button>
                    <button class="admin-btn" onclick="manageCustomers()">👥 会員管理</button>
                    <button class="admin-btn" onclick="addNewArticle()">📝 新記事追加</button>
                </div>
            </div>

            <!-- 新しい記事がここに動的に追加されます -->
        </div>

        <!-- 記事詳細画面 -->
        <div id="articleDetail" class="main-content hidden">
            <article class="article-detail">
                <div class="detail-header">
                    <button class="back-button" onclick="showHome()">← </button>
                    <div class="detail-date" id="detailDate">2025/05/28 (Wed)</div>
                </div>
                
                <div class="detail-image" id="detailImage" style="background-image: url('https://images.unsplash.com/photo-WLUHO9A_xik?w=400&h=280&fit=crop');">
                    <button class="play-button" onclick="toggleMainAudio()">▶</button>
                    <button class="favorite-star" id="detailFavoriteStar" onclick="toggleDetailFavorite()">☆</button>
                </div>
                
                <div class="detail-content">
                    <h1 class="detail-title" id="detailTitle">声が思考をハックする</h1>
                    <div class="detail-subtitle" id="detailSubtitle">2025/05/28 (Wed)</div>
                    
                    <!-- 音声プレーヤー -->
                    <div class="audio-player">
    <div class="player-controls">
        <button class="player-btn" id="mainPlayBtn" onclick="toggleMainAudio()">▶</button>
        <div class="speed-control">
            <span class="speed-label">速度:</span>
            <button class="speed-btn" onclick="changeSpeed(0.5)">0.5x</button>
            <button class="speed-btn active" onclick="changeSpeed(1.0)">1x</button>
            <button class="speed-btn" onclick="changeSpeed(1.25)">1.25x</button>
            <button class="speed-btn" onclick="changeSpeed(1.5)">1.5x</button>
            <button class="speed-btn" onclick="changeSpeed(2.0)">2x</button>
        </div>
        <div class="time-display">
            <span id="currentTime">00:00</span> / <span id="totalTime">--:--</span>
        </div>
    </div>
<div class="progress-container" onclick="seekAudio(event)">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <audio id="mainAudio" preload="metadata" ontimeupdate="updateProgress()" onloadedmetadata="updateDuration()" onended="audioEnded()">
        <source id="audioSource" src="kainal_radio_001.mp3" type="audio/mpeg">
        <p>お使いのブラウザは音声再生に対応していません。</p>
    </audio>
</div>
                    
                    <div class="detail-text" id="detailText">
                        <p>おはようございます、KAINALです。</p>
                        <p>今日は「声が思考をハックする」というテーマで、海のように深く、そして波のように流れる思考についてお話しします。</p>
                        
                        <h3>音声入力を活用できるかどうかが情報格差を生む</h3>
                        <p>私は、以前から音声入力をオススメしていました。最近、以前にも増して音声入力の重要性が高まっていると感じます。AI時代において、音声入力はとても重要な役割を果たすはずです。</p>
                        
                        <p>ただ、多くの人は「今日から音声入力で仕事をすれば良いんだ。それで良くなるんだ」と勘違いしています。そのようなことではありません。</p>
                        
                        <h3>2つの能力を使ってAIの力を最大限引き出す</h3>
                        <p>私がそれ以上に重要だと思うことは、ひとりで黙々と作業するときに声で伝えられるようになることです。</p>
                        
                        <p>これまでは、仕事と言えばずっとパソコン作業でした。タイピングによって自分の言いたいことを書き出していました。言わば、タイピングのスピードが思考のスピードを決めていたということです。</p>
                    </div>
                    
                    <!-- 今日のまとめ -->
                    <div class="summary-section">
                        <div class="summary-title">🌊 今日のまとめ</div>
                        <div class="summary-item">
                            AI時代において、音声入力は重要な役割を果たします。自分の伝えたいことを構造的かつ瞬時に話せるかどうかで、大きな情報格差が生まれる
                        </div>
                        <div class="summary-item">
                            AIの進化によって音声入力が主流になると、物理的なスピードの制約がなくなる。思考の瞬発力と言葉の解像度を高めることで、AIの力を最大限引き出せる
                        </div>
                        <div class="summary-item">
                            思考の瞬発力と言葉の解像度を高めるには、1分スピーチや手を止めずに行うメモ書きが効果的。思いつくままアウトプットし続けて、音声入力を自分の武器にしよう
                        </div>
                    </div>
                    
                    <!-- お気に入り追加 -->
                    <div class="favorite-section">
                        <button class="favorite-btn" id="contentFavoriteBtn" onclick="toggleDetailFavorite()">☆</button>
                        <span class="favorite-text">お気に入り追加</span>
                    </div>
                    
                    <!-- 評価セクション -->
                    <div class="rating-section">
                        <div class="rating-title">🌊 この記事はいかがでしたか？</div>
                        <div class="star-rating">
                            <span class="star" onclick="setRating(1)">☆</span>
                            <span class="star" onclick="setRating(2)">☆</span>
                            <span class="star" onclick="setRating(3)">☆</span>
                            <span class="star" onclick="setRating(4)">☆</span>
                            <span class="star" onclick="setRating(5)">☆</span>
                        </div>
                        <textarea class="feedback-input" placeholder="感想を入力してください。海のような深い洞察をお聞かせください..."></textarea>
                        <button class="submit-btn" onclick="submitFeedback()">送信</button>
                        
                        <div class="navigation-section">
                            <div></div>
                            <a href="#" class="nav-link">前の記事 →</a>
                        </div>
                    </div>
                </div>
            </article>
        </div>

        <!-- お気に入り画面 -->
        <div id="favoritesScreen" class="main-content hidden">
            <div class="page-header">
                <button class="back-to-home-btn" onclick="showHome()">🏠</button>
                <div class="page-title">🌊 お気に入り</div>
            </div>
            <div id="favoritesList">
                <!-- お気に入り記事がここに表示されます -->
            </div>
        </div>

        <!-- メニュー画面 -->
        <div id="menuScreen" class="main-content hidden">
            <div class="page-header">
                <button class="back-to-home-btn" onclick="showHome()">🏠</button>
                <div class="page-title">🌊 メニュー</div>
            </div>
            
            <!-- 管理者専用メニュー -->
            <div class="admin-dashboard admin-only" style="margin-bottom: 20px;">
                <h3>🔧 管理者専用機能</h3>
                <div class="admin-controls">
                    <button class="admin-btn" onclick="showIdIssueForm()" style="background: #4caf50;">🎫 ID発行</button>
                    <button class="admin-btn" onclick="manageCustomers()">👥 会員管理</button>
                    <button class="admin-btn" onclick="viewAnalytics()">📊 分析データ</button>
                    <button class="admin-btn" onclick="exportData()">💾 データエクスポート</button>
                </div>
            </div>

            <div style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <div style="padding: 16px 0; border-bottom: 1px solid #e3f2fd; cursor: pointer; color: #1976d2;">通知設定</div>
                <div style="padding: 16px 0; border-bottom: 1px solid #e3f2fd; cursor: pointer; color: #1976d2;">パスワード変更</div>
                <div style="padding: 16px 0; border-bottom: 1px solid #e3f2fd; cursor: pointer; color: #1976d2;" onclick="logout()">ログアウト</div>
                <div style="padding: 16px 0; cursor: pointer; color: #1976d2;">利用規約</div>
            </div>
        </div>

        <!-- 会員管理画面 -->
        <div id="membersScreen" class="main-content hidden">
            <div class="page-header">
                <button class="back-to-home-btn" onclick="showHome()">🏠</button>
                <div class="page-title">👥 会員管理</div>
            </div>
            
            <!-- 検索バー -->
            <div style="background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <input type="text" id="memberSearch" placeholder="🔍 会員を検索..." oninput="filterMembers()" style="...">
            </div>

            <!-- ID発行ボタン -->
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="admin-btn" onclick="showIdIssueForm()" style="background: #4caf50; padding: 12px 24px;">🎫 新規ID発行</button>
            </div>

            <!-- 会員リスト -->
            <div id="membersList">
                <!-- 会員カードがここに表示されます -->
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- テンプレート管理画面 -->
    <div id="templatesScreen" class="main-content hidden">
        <div class="page-header">
            <button class="back-to-home-btn" onclick="showHome()">🏠</button>
            <div class="page-title">🖼️ Canvaテンプレート管理</div>
        </div>

        <div style="text-align: center; margin-bottom: 40px;">
            <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 32px; border-radius: 20px; margin-bottom: 24px;">
                <h2 style="color: #1976d2; margin-bottom: 12px; font-size: 24px;">🖼️ Canvaテンプレート</h2>
                <p style="color: #666; font-size: 16px; margin: 0;">デザインテンプレートを効率的に管理しましょう</p>
            </div>
        </div>


        </div>

<!-- テンプレート追加ボタン -->
        <div class="template-add-section">
            <button class="template-add-btn admin-only" onclick="showAddTemplateModal()">
                <span class="add-icon">➕</span>
                <span>テンプレートを追加</span>
            </button>
        </div>

        <!-- テンプレートグリッド -->
        <div id="templatesGrid" class="templates-grid">
            <!-- テンプレートカードがここに表示されます -->
        </div>

<!-- 空の状態 -->
        <div id="emptyTemplates" class="empty-templates hidden">
            <div class="empty-icon">🖼️</div>
        </div>
    </div>

<!-- 底部ナビゲーション -->
<nav class="bottom-nav hidden" id="bottomNav">
    <div class="nav-item" onclick="event.stopPropagation(); showTemplates();">
        <div class="nav-icon">🖼️</div>
        <div>テンプレート</div>
    </div>
    <div class="nav-item active" onclick="event.stopPropagation(); showHome();">
        <div class="nav-icon">🏠</div>
        <div>ホーム</div>
    </div>
    <div class="nav-item" onclick="event.stopPropagation(); showFavorites();">
        <div class="nav-icon">⭐</div>
        <div>お気に入り</div>
    </div>
    <div class="nav-item" onclick="event.stopPropagation(); showMenu();">
        <div class="nav-icon">☰</div>
        <div>メニュー</div>
    </div>
</nav>

    <!-- ID発行モーダル -->
    <div id="idIssueModal" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('idIssueModal').classList.add('hidden')">&times;</span>
            <h3>🎫 新規ID発行</h3>
            <p style="color: #666; margin-bottom: 20px;">会員の基本情報を入力してIDを発行します</p>
            
            <div id="idIssueForm">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">👤 お名前</label>
                <input type="text" id="memberName" placeholder="例：田中太郎" required>
                
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">📧 メールアドレス</label>
                <input type="email" id="memberEmail" placeholder="例：tanaka@example.com" required>
                
                <div style="width: 100%; background: #4caf50; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; text-align: center; user-select: none;" onclick="generateMemberId();">🎫 ID発行</div>
            </div>

            <!-- ID発行結果 -->
            <div id="idResult" class="hidden">
                <!-- 発行結果がここに表示されます -->
            </div>
        </div>
    </div>

<!-- 記事追加モーダル -->
    <div id="addArticleModal" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="closeAddArticleModal()">&times;</span>
            <h3>📝 新記事追加</h3>
            <form id="addArticleForm">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">📝 記事タイトル</label>
                <input type="text" id="articleTitle" placeholder="例：音声入力で生産性を向上させる方法" required>
                
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">🎵 音声ファイル</label>
<div class="audio-upload-section">
    <input type="file" id="audioFileInput" accept="audio/*" style="display: none;" onchange="handleAudioFileUpload(event)">
    <div class="upload-area" onclick="document.getElementById('audioFileInput').click()" style="border: 2px dashed #1976d2; border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; background: #f8f9fa; transition: all 0.3s;" ondrop="handleAudioDrop(event)" ondragover="handleAudioDragOver(event)" ondragleave="handleAudioDragLeave(event)">
        <div class="upload-icon" style="font-size: 48px; margin-bottom: 12px;">🎵</div>
        <div class="upload-text" style="font-size: 16px; color: #1976d2; font-weight: 600; margin-bottom: 8px;">音声ファイルをアップロード</div>
        <div class="upload-subtext" style="font-size: 14px; color: #666;">クリックまたはドラッグ&ドロップ</div>
        <div style="font-size: 12px; color: #999; margin-top: 8px;">対応形式: MP3, WAV, M4A</div>
    </div>
    <div id="uploadedFileName" style="margin-top: 12px; padding: 8px; background: #e3f2fd; border-radius: 8px; font-size: 14px; color: #1976d2; display: none;">
        <span id="fileName"></span>
        <button type="button" onclick="removeUploadedFile()" style="float: right; background: none; border: none; color: #f44336; cursor: pointer;">×</button>
    </div>
</div>
                
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">📄 記事内容</label>
                <textarea id="articleContent" placeholder="記事の詳細内容を入力してください..." rows="8" style="resize: vertical;"></textarea>
                
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">📝 今日のまとめ（3つのポイント）</label>
                <textarea id="summaryPoint1" placeholder="ポイント1: 例）音声入力は思考の整理に効果的" rows="2" style="margin-bottom: 8px;"></textarea>
                <textarea id="summaryPoint2" placeholder="ポイント2: 例）タイピングより高速で自然な表現が可能" rows="2" style="margin-bottom: 8px;"></textarea>
                <textarea id="summaryPoint3" placeholder="ポイント3: 例）継続的な練習で精度が向上する" rows="2" style="margin-bottom: 16px;"></textarea>
                
                <!-- 自動選択された画像のプレビュー -->
                <div class="image-preview">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">🖼️ 記事画像</label>
                    <div id="previewImage" class="preview-image" style="background-image: url('https://images.unsplash.com/photo-WLUHO9A_xik?w=400&h=280&fit=crop');"></div>
                    <button type="button" class="refresh-image-btn" onclick="generateNewImage()">🔄 画像を更新</button>
                </div>
                
                <button type="button" onclick="addNewArticleToList()" style="width: 100%; background: #1976d2; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 16px;">📝 記事を追加</button>
            </form>
        </div>
    </div>
    </form>
        </div>
    </div>

<!-- テンプレート追加モーダル -->
    <!-- テンプレート追加モーダル -->
    <div id="addTemplateModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <span class="close" onclick="closeAddTemplateModal()">&times;</span>
            <h3>🖼️ Canvaテンプレート一括追加</h3>
            
            <!-- 管理者用：会員選択 -->
            <div class="admin-only" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">👤 追加先の会員</label>
                <input type="text" id="modalMemberSearch" placeholder="🔍 会員を検索..." onkeyup="filterModalMembers()" style="width: 100%; padding: 12px; border: 2px solid #e3f2fd; border-radius: 8px; font-size: 16px; margin-bottom: 8px;">
                <select id="modalMemberSelect" style="width: 100%; padding: 12px; border: 2px solid #e3f2fd; border-radius: 8px; font-size: 16px;">
                    <option value="">会員を選択してください</option>
                </select>
            </div>
            
            <form id="addTemplateForm">
                <div style="background: #e3f2fd; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #1976d2; font-weight: 600; margin-bottom: 8px;">💡 使い方</div>
                    <div style="font-size: 12px; color: #666;">
                        最大5つのテンプレートを一度に追加できます。<br>
                        URLとタイトルをそれぞれ入力してください。
                    </div>
                </div>
                
                <!-- テンプレート入力エリア -->
                <div id="templateInputsContainer">
                    <!-- 1つ目 -->
                    <div class="template-input-row" style="background: white; border: 2px solid #e3f2fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <span style="background: #1976d2; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 12px;">1</span>
                            <h4 style="margin: 0; color: #1976d2; font-size: 16px;">テンプレート1</h4>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px;">📝 テンプレート名</label>
                            <input type="text" class="template-title" placeholder="例：Instagram投稿用テンプレート" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px;">🔗 CanvaのURL</label>
                            <input type="url" class="template-url" placeholder="https://www.canva.com/design/xxxxx" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <!-- 2つ目 -->
                    <div class="template-input-row" style="background: white; border: 2px solid #e3f2fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <span style="background: #1976d2; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 12px;">2</span>
                            <h4 style="margin: 0; color: #1976d2; font-size: 16px;">テンプレート2</h4>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px;">📝 テンプレート名</label>
                            <input type="text" class="template-title" placeholder="例：Facebook投稿用テンプレート" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px;">🔗 CanvaのURL</label>
                            <input type="url" class="template-url" placeholder="https://www.canva.com/design/yyyyy" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <!-- 3つ目 -->
                    <div class="template-input-row" style="background: white; border: 2px solid #e3f2fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <span style="background: #1976d2; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 12px;">3</span>
                            <h4 style="margin: 0; color: #1976d2; font-size: 16px;">テンプレート3</h4>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px;">📝 テンプレート名</label>
                            <input type="text" class="template-title" placeholder="例：ポスター・チラシ用テンプレート" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px;">🔗 CanvaのURL</label>
                            <input type="url" class="template-url" placeholder="https://www.canva.com/design/zzzzz" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <!-- 4つ目 -->
                    <div class="template-input-row" style="background: white; border: 2px solid #e3f2fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <span style="background: #1976d2; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 12px;">4</span>
                            <h4 style="margin: 0; color: #1976d2; font-size: 16px;">テンプレート4</h4>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px;">📝 テンプレート名</label>
                            <input type="text" class="template-title" placeholder="例：プレゼンテーション用テンプレート" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px;">🔗 CanvaのURL</label>
                            <input type="url" class="template-url" placeholder="https://www.canva.com/design/aaaaa" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <!-- 5つ目 -->
                    <div class="template-input-row" style="background: white; border: 2px solid #e3f2fd; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <span style="background: #1976d2; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 12px;">5</span>
                            <h4 style="margin: 0; color: #1976d2; font-size: 16px;">テンプレート5</h4>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px;">📝 テンプレート名</label>
                            <input type="text" class="template-title" placeholder="例：名刺・ビジネスカード用テンプレート" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px;">🔗 CanvaのURL</label>
                            <input type="url" class="template-url" placeholder="https://www.canva.com/design/bbbbb" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>
                </div>
                
                <button type="button" onclick="addBulkTemplatesNew()" style="width: 100%; background: linear-gradient(135deg, #42a5f5, #1976d2); color: white; padding: 14px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 16px;">🖼️ 選択したテンプレートを追加</button>
            </form>
        </div>
    </div>
    <script>
// グローバル変数
let currentUser = null;
let nextMemberId = 1;
let currentArticleId = null;
let nextArticleId = 5;
let templates = {}; // テンプレートデータ
let nextTemplateId = 1;
let currentSelectedMember = ''; // 選択中の会員
        
        // 認証システム
        let validUsers = {
            'ADMIN001': { 
                loginId: 'admin',
                password: 'kainal2025', 
                role: 'admin', 
                name: 'KAINAL管理者', 
                email: 'admin@kainal.com' 
            }
        };

        // 海の画像キーワードリスト
        const oceanKeywords = [
            'ocean,wave,blue',
            'sea,calm,peaceful',
            'ocean,deep,mysterious',
            'wave,power,energy',
            'beach,sunset,serene',
            'sea,storm,dramatic',
            'ocean,underwater,blue',
            'wave,breaking,dynamic',
            'sea,horizon,infinite',
            'ocean,surface,reflection'
        ];

        // 記事内容に基づいて適切な海の画像キーワードを選択
        function selectImageKeywords(title, content) {
            const text = (title + ' ' + content).toLowerCase();
            
            if (text.includes('思考') || text.includes('考え')) {
                return 'ocean,deep,thought';
            } else if (text.includes('力') || text.includes('パワー') || text.includes('カオス')) {
                return 'sea,storm,power';
            } else if (text.includes('学び') || text.includes('深い')) {
                return 'ocean,deep,calm';
            } else if (text.includes('創造') || text.includes('クリエイティブ')) {
                return 'beach,sunset,creativity';
            } else if (text.includes('変化') || text.includes('変える')) {
                return 'wave,change,dynamic';
            } else {
                // ランダムに海のキーワードを選択
                const randomIndex = Math.floor(Math.random() * oceanKeywords.length);
                return oceanKeywords[randomIndex];
            }
        }

function generateOceanImageUrl(keywords) {
    // 美しい海の画像URL（厳選された海の風景のみ）
    const oceanImages = [
        'https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=400&h=280&fit=crop', // 静かな海
        'https://images.unsplash.com/photo-1544551763-46a013bb70d5?w=400&h=280&fit=crop', // 波打つ海
        'https://images.unsplash.com/photo-1439066615861-d1af74d74000?w=400&h=280&fit=crop', // 深い青い海
        'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=400&h=280&fit=crop', // 夕日の海
        'https://images.unsplash.com/photo-1518837695005-2083093ee35b?w=400&h=280&fit=crop', // 透明な海
        'https://images.unsplash.com/photo-1544966503-7cc5ac882d5c?w=400&h=280&fit=crop'  // 穏やかな海
    ];
    
    // ランダムに選択
    const randomIndex = Math.floor(Math.random() * oceanImages.length);
    return oceanImages[randomIndex];
}
// 記事データ（新規投稿用に初期化）
const articles = {};

        // ページ読み込み時の初期化
window.addEventListener('load', function() {
    console.log('ページ読み込み完了');
    loadMemberData();
    
    // 全モーダルを強制的に閉じる
    const modals = ['idIssueModal', 'addArticleModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
    });
    
    // キーボードイベント
    setupKeyboardEvents();
    
    // URLハッシュからユーザー識別
    const hash = window.location.hash;
    if (hash) {
        if (hash === '#admin') {
            // 管理者のセッション復元
            const adminSession = sessionStorage.getItem('kainal_session_admin');
            if (adminSession) {
                currentUser = JSON.parse(adminSession);
                showMainApp();
                return;
            }
        } else if (hash.startsWith('#user-')) {
            // 会員のセッション復元
            const userId = hash.replace('#user-', '');
            const userSession = sessionStorage.getItem(`kainal_session_${userId}`);
            if (userSession) {
                const storedUser = JSON.parse(userSession);
                
                // ユーザーが存在するかチェック
                if (validUsers[userId]) {
                    currentUser = storedUser;
                    showMainApp();
                    return;
                }
            }
        }
    }
    
    // セッションがない場合はログイン画面表示
    showLoginScreen();
});

// ログイン画面を表示する関数
function showLoginScreen() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('bottomNav').classList.add('hidden');
    
    // テンプレート関連要素を強制非表示
    setTimeout(() => {
        const templateElements = document.querySelectorAll('.template-add-section, #customerTemplateHeader');
        templateElements.forEach(element => {
            if (element) {
                element.style.display = 'none';
                element.style.visibility = 'hidden';
            }
        });
    }, 100);
}

        // キーボードイベント設定
        function setupKeyboardEvents() {
            const userIdInput = document.getElementById('userId');
            const userEmailInput = document.getElementById('userEmail');
            
            if (userIdInput) {
                userIdInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        doLogin();
                    }
                });
            }
            
            if (userEmailInput) {
                userEmailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        doLogin();
                    }
                });
            }
        }

        // ログイン処理
function doLogin() {
    console.log('ログイン処理開始');
    
    const userIdInput = document.getElementById('userId');
    const userEmailInput = document.getElementById('userEmail');
    const errorDiv = document.getElementById('errorMessage');
    
    if (!userIdInput || !userEmailInput) {
        console.error('入力要素が見つかりません');
        return;
    }
    
    const userId = userIdInput.value.trim();
    const userEmail = userEmailInput.value.trim();
    
    console.log('入力値:', { userId, userEmail });
    
    // エラーメッセージを初期化
    errorDiv.classList.add('hidden');
    errorDiv.textContent = '';
    
    // 入力チェック
    if (!userId || !userEmail) {
        showError('ログインIDとメールアドレスを入力してください');
        return;
    }
    
    // 管理者ログイン
    if (userId.toLowerCase() === 'admin' && userEmail.toLowerCase() === 'admin@kainal.com') {
        console.log('管理者ログイン成功');
        currentUser = { 
            userId: 'ADMIN001', 
            loginId: 'admin',
            role: 'admin', 
            name: 'KAINAL管理者', 
            email: 'admin@kainal.com' 
        };
        
        // 管理者専用のセッション保存とURL設定
        const sessionKey = 'kainal_session_admin';
        sessionStorage.setItem(sessionKey, JSON.stringify(currentUser));
        window.location.hash = '#admin';
        
        showMainApp();
       showNotification('🧭 ログイン成功！ KAINAL Compassへようこそ');
        return;
    }
    
   // 一般ユーザーログインチェック（大文字小文字を区別しない改善版）
let foundUserId = null;
let foundUser = null;

// validUsersのキーと値の両方をチェックして正しいuserIdを取得
Object.keys(validUsers).forEach(uid => {
    const u = validUsers[uid];
    if (u.loginId && u.email) {
        const storedLoginId = u.loginId.toString().toLowerCase().trim();
        const storedEmail = u.email.toString().toLowerCase().trim();
        const inputLoginId = userId.toString().toLowerCase().trim();
        const inputEmail = userEmail.toString().toLowerCase().trim();
        
        if (storedLoginId === inputLoginId && storedEmail === inputEmail) {
            foundUserId = uid;
            foundUser = u;
        }
    }
});

    if (foundUser && foundUserId) {
        console.log('一般ユーザーログイン成功');
        // userIdを含めたcurrentUserオブジェクトを作成
        currentUser = {
            ...foundUser,
            userId: foundUserId  // 重要：userIdを明示的に設定
        };
        
        // 会員専用のセッション保存とURL設定
        const sessionKey = `kainal_session_${foundUserId}`;
        sessionStorage.setItem(sessionKey, JSON.stringify(currentUser));
        window.location.hash = `#user-${foundUserId}`;
        
        showMainApp();
        showNotification(`🌊 ログイン成功！ ${foundUser.name}さん、ようこそ`);
    } else {
        console.log('ログイン失敗');
        showError('ログインIDまたはメールアドレスが正しくありません');
    }
}

        // エラー表示関数
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
        }

        // 通知表示関数
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(25,118,210,0.9);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 1001;
                font-size: 14px;
                backdrop-filter: blur(10px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // メインアプリ表示
        function showMainApp() {
    console.log('メインアプリ表示');
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('bottomNav').classList.remove('hidden');
    
    // 確実に底部ナビゲーションを表示
    const bottomNav = document.getElementById('bottomNav');
    bottomNav.style.display = 'flex';
    bottomNav.style.visibility = 'visible';
    
    // ユーザー情報表示
    document.getElementById('userInfo').textContent = currentUser.name || currentUser.userId;
    
    // 管理者モードの切り替え
    if (currentUser.role === 'admin') {
        document.body.classList.add('admin-mode');
    } else {
        document.body.classList.remove('admin-mode');
    }
    
    updateHomeFavoriteButtons();
    updateFavoritesList();
    updateMemberCount();
    showHome();
}

        // ログアウト
function logout() {
    if (currentUser) {
        // 現在のユーザーのセッションを削除
        if (currentUser.role === 'admin') {
            sessionStorage.removeItem('kainal_session_admin');
        } else {
            sessionStorage.removeItem(`kainal_session_${currentUser.userId}`);
        }
    }
    
    // URLハッシュをクリア
    window.location.hash = '';
    
    currentUser = null;
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('bottomNav').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('userId').value = '';
    document.getElementById('userEmail').value = '';
    document.body.classList.remove('admin-mode');
    showNotification('🌊 ログアウトしました');
}

        // LocalStorageから会員データを読み込み
        function loadMemberData() {
            const savedUsers = localStorage.getItem('kainal_users');
            if (savedUsers) {
                const loadedUsers = JSON.parse(savedUsers);
                validUsers = { ...validUsers, ...loadedUsers };
            }
            
            const savedNextId = localStorage.getItem('kainal_next_id');
            if (savedNextId) {
                nextMemberId = parseInt(savedNextId);
            }
        }

        // 会員データをLocalStorageに保存
        function saveMemberData() {
            localStorage.setItem('kainal_users', JSON.stringify(validUsers));
            localStorage.setItem('kainal_next_id', nextMemberId.toString());
        }

        // ID発行機能
        function showIdIssueForm() {
            const modal = document.getElementById('idIssueModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            document.getElementById('idResult').classList.add('hidden');
            document.getElementById('memberName').value = '';
            document.getElementById('memberEmail').value = '';
        }

        function generateMemberId() {
            const name = document.getElementById('memberName').value.trim();
            const email = document.getElementById('memberEmail').value.trim();
            
            if (!name || !email) {
                alert('名前とメールアドレスを入力してください');
                return;
            }

            // 重複チェック
            const existingUser = Object.values(validUsers).find(user => user.email === email);
            if (existingUser) {
                alert('このメールアドレスは既に登録されています');
                return;
            }

            // ログインID生成
            const loginId = generateLoginId(name, nextMemberId);
            const userId = `KAINAL${nextMemberId.toString().padStart(3, '0')}`;

            // ユーザー登録
            validUsers[userId] = {
                loginId: loginId,
                role: 'customer',
                name: name,
                email: email
            };

            nextMemberId++;
            saveMemberData();

            // 結果表示
            showIdResult(userId, loginId, name, email);
            updateMemberCount();
        }


// ログインID生成関数
function generateLoginId(name, number) {
    const parts = name.trim().split(/\s+/);
    const lastName = parts[0] || '';
    const firstName = parts[1] || '';
    
    // 拡張された漢字→ローマ字変換辞書
    const kanjiToRoman = {
        // 姓によく使われる漢字
        '中':'n', '村':'m', '田':'t', '佐':'s', '藤':'f', '山':'y',
        '高':'t', '橋':'h', '岸':'k', '本':'m', '木':'k', '川':'k',
        '渡':'w', '辺':'b', '邉':'w', '邊':'w', '部':'b', '野':'n',
        '井':'i', '上':'u', '下':'s', '小':'k', '大':'o', '長':'n',
        '石':'i', '松':'m', '林':'h', '森':'m', '竹':'t', '梅':'u',
        '桜':'s', '柳':'y', '杉':'s', '原':'h', '池':'i', '沼':'n',
        '島':'s', '浜':'h', '海':'k', '岡':'o', '峰':'m', '谷':'t',
        '坂':'s', '丘':'o', '平':'h', '西':'n', '東':'h', '南':'m',
        '北':'k', '内':'u', '外':'s', '前':'m', '後':'g', '新':'s',
        '古':'f', '若':'w', '老':'r', '青':'a', '白':'s', '黒':'k',
        '赤':'a', '金':'k', '銀':'g', '鉄':'t', '水':'m', '火':'h',
        '土':'t', '風':'k', '雲':'k', '雨':'a', '雪':'y', '星':'h',
        '月':'t', '日':'h', '光':'k', '影':'k', '春':'h', '夏':'n',
        '秋':'a', '冬':'f', '朝':'a', '夜':'y', '早':'h', '遅':'o',
        
        // 名によく使われる漢字
        '太':'t', '郎':'r', '花':'h', '子':'k', '美':'m', '咲':'s',
        '啓':'k', '邦':'k', '秀':'h', '一':'i', '二':'n', '三':'s',
        '和':'w', '雄':'y', '恵':'e', '愛':'a', '香':'k', '晃':'a',
        '明':'a', '聡':'s', '智':'t', '知':'t', '真':'m', '正':'m',
        '清':'s', '純':'j', '誠':'m', '信':'s', '忠':'t', '孝':'k',
        '仁':'j', '義':'g', '礼':'r', '勇':'y', '健':'k', '強':'t',
        '優':'y', '良':'r', '善':'z', '慎':'s', '謙':'k', '温':'o',
        '穏':'o', '静':'s', '安':'a', '平':'h', '康':'k', '幸':'k',
        '福':'f', '富':'t', '豊':'y', '栄':'e', '昌':'s', '繁':'s',
        '隆':'r', '盛':'s', '興':'k', '発':'h', '進':'s', '歩':'a',
        '走':'h', '飛':'t', '翔':'s', '舞':'m', '歌':'u', '音':'o',
        '響':'k', '鳴':'n', '呼':'y', '言':'g', '語':'g', '話':'w',
        '読':'y', '書':'s', '文':'b', '字':'j', '学':'g', '習':'s',
        '教':'k', '授':'j', '師':'s', '匠':'t', '職':'s', '業':'g',
        '作':'s', '創':'s', '建':'k', '造':'z', '設':'s', '計':'k',
        '図':'z', '画':'g', '絵':'e', '色':'i', '形':'k', '様':'y'
    };
    
    const getAlphabetChar = (str) => {
        if (!str) return 'u'; // デフォルト文字
        
        for (let i = 0; i < str.length; i++) {
            const char = str.charAt(i);
            
            // 既に英字の場合はそのまま使用
            if (/[a-zA-Z]/.test(char)) {
                return char.toLowerCase();
            }
            
            // 漢字辞書にある場合は変換
            if (kanjiToRoman[char]) {
                return kanjiToRoman[char];
            }
        }
        
        // 辞書にない場合は名前の長さに基づいてランダム文字を生成
        const alphabets = 'abcdefghijklmnopqrstuvwxyz';
        const index = str.length % alphabets.length;
        return alphabets[index];
    };
    
    const firstChar = getAlphabetChar(lastName);
    const secondChar = getAlphabetChar(firstName);
    
    let loginId;
    let attempts = 0;
    do {
        const randomNum = Math.floor(Math.random() * 9000) + 1000;
        loginId = `${firstChar}${secondChar}${randomNum}`;
        attempts++;
        
        // 100回試行しても重複する場合は、より長いIDを生成
        if (attempts >= 100) {
            const extraChar = alphabets[Math.floor(Math.random() * 26)];
            loginId = `${firstChar}${secondChar}${extraChar}${randomNum}`;
            break;
        }
    } while (Object.values(validUsers).some(user => user.loginId === loginId) && attempts < 100);
    
    return loginId;
}

        function showIdResult(userId, loginId, name, email) {
            const resultDiv = document.getElementById('idResult');
            resultDiv.innerHTML = `
                <div class="id-result">
                    <h4>🎉 ID発行完了！</h4>
                    <div class="id-info">
                        <div style="margin-bottom: 8px;"><strong>👤 お名前:</strong> ${name}</div>
                        <div style="margin-bottom: 8px;"><strong>📧 メール:</strong> ${email}</div>
                        <div style="margin-bottom: 8px;"><strong>🆔 ログインID:</strong> ${loginId} <button class="copy-btn" onclick="copyToClipboard('${loginId}')">📋</button></div>
                        <div style="margin-bottom: 8px;"><strong>🔑 認証用メール:</strong> ${email} <button class="copy-btn" onclick="copyToClipboard('${email}')">📋</button></div>
                    </div>
                    <p style="font-size: 14px; opacity: 0.9; margin-top: 16px;">
                        📱 この情報を会員様にお伝えください<br>
                        🔒 ログインにはログインIDとメールアドレスが必要です
                    </p>
                    <button class="copy-btn" onclick="copyAllInfo('${loginId}', '${email}', '${name}')" style="margin-top: 12px; padding: 8px 16px;">📋 全情報をコピー</button>
                </div>
            `;
            resultDiv.classList.remove('hidden');
            
            document.getElementById('idIssueForm').style.display = 'none';
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('📋 コピーしました！');
            });
        }

        function copyAllInfo(loginId, email, name) {
            const info = `🧭 KAINAL Compass ログイン情報\n\n👤 お名前: ${name}\n🆔 ログインID: ${loginId}\n📧 メールアドレス: ${email}\n\n💻 ログインURL: [サイトURL]\n\nログインIDとメールアドレスでログインしてください！`;
            
            navigator.clipboard.writeText(info).then(() => {
                showNotification('📋 全情報をコピーしました！');
            });
        }

        // 会員管理
        function manageCustomers() {
            hideAllScreens();
            document.getElementById('membersScreen').classList.remove('hidden');
            setActiveNavItem(-1);
            updateMembersList();
        }

        function updateMembersList() {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';

            Object.keys(validUsers).forEach(userId => {
                const user = validUsers[userId];
                const memberCard = document.createElement('div');
                memberCard.className = 'member-card';
                
                memberCard.innerHTML = `
                    <div class="member-card-header">
                        <div class="member-info">
                            <div class="member-name">${user.name}</div>
                            <div class="member-email">ID: ${user.loginId} | ${user.email}</div>
                        </div>
                        <div class="member-role ${user.role}">${user.role === 'admin' ? '管理者' : '会員'}</div>
                    </div>
                    <div class="member-actions">
                        <button class="action-btn edit-btn" onclick="editMember('${userId}')">✏️ 編集</button>
                        <button class="action-btn delete-btn" onclick="deleteMember('${userId}')" ${user.role === 'admin' ? 'disabled style="opacity:0.5"' : ''}>🗑️ 削除</button>
                    </div>
                `;
                
                membersList.appendChild(memberCard);
            });
        }

        function editMember(userId) {
            const user = validUsers[userId];
            const newName = prompt(`会員名を編集\n\n現在: ${user.name}`, user.name);
            if (newName && newName !== user.name) {
                validUsers[userId].name = newName;
                saveMemberData();
                updateMembersList();
                alert('✅ 会員情報を更新しました');
            }
        }

        function deleteMember(userId) {
            const user = validUsers[userId];
            if (user.role === 'admin') {
                alert('❌ 管理者アカウントは削除できません');
                return;
            }
            
            if (confirm(`本当に ${user.name} を削除しますか？\n\nID: ${userId}\nメール: ${user.email}`)) {
                delete validUsers[userId];
                saveMemberData();
                updateMembersList();
                updateMemberCount();
                alert('✅ 会員を削除しました');
            }
        }

        function updateMemberCount() {
            const customerCount = Object.values(validUsers).filter(user => user.role === 'customer').length;
            const memberCountEl = document.getElementById('memberCount');
            if (memberCountEl) {
                memberCountEl.textContent = customerCount;
            }
        }

        // 新記事追加機能
        function addNewArticle() {
            document.getElementById('addArticleModal').classList.remove('hidden');
            generateNewImage();
        }

        function closeAddArticleModal() {
            document.getElementById('addArticleModal').classList.add('hidden');
            document.getElementById('addArticleForm').reset();
        }

// 新しい画像を生成
        function generateNewImage() {
            const title = document.getElementById('articleTitle').value;
            const content = document.getElementById('articleContent').value;
            
            let keywords;
            if (title || content) {
                keywords = selectImageKeywords(title, content);
            } else {
                const randomIndex = Math.floor(Math.random() * oceanKeywords.length);
                keywords = oceanKeywords[randomIndex];
            }
            
            const imageUrl = generateOceanImageUrl(keywords);
            document.getElementById('previewImage').style.backgroundImage = `url('${imageUrl}')`;
            
            // 画像更新の通知
            showNotification('🖼️ 画像を更新しました');
        }
        
        // モーダルを開いたときに自動で画像を生成
        function addNewArticle() {
            document.getElementById('addArticleModal').classList.remove('hidden');
            document.getElementById('addArticleModal').style.display = 'flex';
            generateNewImage();
            
            // タイトル入力にフォーカス
            setTimeout(() => {
                document.getElementById('articleTitle').focus();
            }, 100);
        }

        function editArticle(articleId) {
            alert(`✏️ 記事編集: ${articles[articleId].title}\n\n現在の実装では、JavaScriptのarticlesオブジェクトを直接編集してください。\n\n将来的には記事編集インターフェースを実装予定です。`);
        }

        function viewAnalytics() {
    hideAllScreens();
    showAnalyticsScreen();
    setActiveNavItem(-1);
}

function showAnalyticsScreen() {
    // 分析画面が存在しない場合は作成
    let analyticsScreen = document.getElementById('analyticsScreen');
    if (!analyticsScreen) {
        createAnalyticsScreen();
        analyticsScreen = document.getElementById('analyticsScreen');
    }
    
    analyticsScreen.classList.remove('hidden');
    updateAnalyticsData();
}

function createAnalyticsScreen() {
    const mainApp = document.getElementById('mainApp');
    const analyticsHTML = `
        <div id="analyticsScreen" class="main-content hidden">
            <div class="page-header">
                <button class="back-to-home-btn" onclick="showHome()">🏠</button>
                <div class="page-title">📊 分析データ</div>
            </div>
            
            <!-- 総合統計 -->
            <div class="analytics-overview" style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <h3 style="color: #1976d2; margin-bottom: 20px; text-align: center;">📈 総合統計</h3>
                <div class="analytics-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px;">
                    <div class="analytics-stat-card" style="background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; padding: 16px; border-radius: 12px; text-align: center;">
                        <div class="stat-number" id="totalPlaysCount" style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">0</div>
                        <div class="stat-label" style="font-size: 12px; opacity: 0.9;">総再生数</div>
                    </div>
                    <div class="analytics-stat-card" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; padding: 16px; border-radius: 12px; text-align: center;">
                        <div class="stat-number" id="avgRatingValue" style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">0.0</div>
                        <div class="stat-label" style="font-size: 12px; opacity: 0.9;">平均評価</div>
                    </div>
                    <div class="analytics-stat-card" style="background: linear-gradient(135deg, #ff9800, #ffb74d); color: white; padding: 16px; border-radius: 12px; text-align: center;">
                        <div class="stat-number" id="totalRatingsCount" style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">0</div>
                        <div class="stat-label" style="font-size: 12px; opacity: 0.9;">評価総数</div>
                    </div>
                </div>
            </div>
            
            <!-- 人気記事ランキング -->
            <div class="popular-articles" style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <h3 style="color: #1976d2; margin-bottom: 20px;">🏆 人気記事ランキング</h3>
                <div id="popularArticlesList"></div>
            </div>
            
            <!-- 記事別詳細データ -->
            <div class="article-details" style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <h3 style="color: #1976d2; margin-bottom: 20px;">📑 記事別詳細データ</h3>
                <div id="articleDetailsList"></div>
            </div>
            
            <!-- 最新の評価・感想 -->
            <div class="recent-feedback" style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 40px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <h3 style="color: #1976d2; margin-bottom: 20px;">💬 最新の評価・感想</h3>
                <div id="recentFeedbackList"></div>
            </div>
        </div>
    `;
    
    mainApp.insertAdjacentHTML('beforeend', analyticsHTML);
}

        function exportData() {
            alert('💾 データエクスポート\n\n• 会員リスト\n• 再生統計\n• 評価データ\n• 感想コメント\n\n(実装予定)');
        }

            function addNewArticleToList() {
    const title = document.getElementById('articleTitle').value;
    const content = document.getElementById('articleContent').value;
    
    // 音声ファイルのチェック
    if (!uploadedAudioFile) {
        alert('音声ファイルをアップロードしてください。');
        return;
    }
    
    // ファイル名を生成（実際のアップロード処理では、サーバーが返すURLを使用）
    const audioFileName = `kainal_radio_${String(nextArticleId).padStart(3, '0')}.mp3`;
            
            if (title && audioFile) {
                const today = new Date();
                const dateStr = today.getFullYear() + '/' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '/' + 
                               String(today.getDate()).padStart(2, '0') + 
                               ' (' + ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][today.getDay()] + ')';
                
                // 画像URLを取得
                const previewImage = document.getElementById('previewImage');
                const imageUrl = previewImage.style.backgroundImage.slice(5, -2);
                
                // 新記事データを作成
                articles[nextArticleId] = {
                    title: title,
                    date: dateStr,
                    image: imageUrl,
                    audioFile: audioFile,
                    content: content || `<p>${title}の内容です。</p><h3>概要</h3><p>この記事では${title}について詳しく解説します。</p>`
                };
                
                // リアルタイムでホーム画面に追加
                addNewArticleToHome(nextArticleId);
                
                nextArticleId++;
                
                // 投稿記事数を更新
                updateArticleCount();
                
                showNotification('✅ 新記事が追加されました！');
                document.getElementById('addArticleForm').reset();
                closeAddArticleModal();
                
                // ホーム画面に戻る
                showHome();
            } else {
                alert('記事タイトルと音声ファイル名を入力してください。');
            }
        }
        
        // 新記事をホーム画面にリアルタイム追加
        function addNewArticleToHome(articleId) {
            const article = articles[articleId];
            const homeScreen = document.getElementById('homeScreen');
            
            // 新記事カードを作成
            const newArticleCard = document.createElement('article');
            newArticleCard.className = 'article-card';
            newArticleCard.onclick = () => showArticle(articleId);
            
            newArticleCard.innerHTML = `
                <div class="article-image" style="background-image: url('${article.image}');">
                    <button class="admin-edit-btn admin-only" onclick="event.stopPropagation(); editArticle(${articleId})" title="記事を編集">✏️</button>
                    <button class="card-favorite-btn" onclick="event.stopPropagation(); toggleCardFavorite(${articleId}, this)">☆</button>
                </div>
                <div class="article-info">
                    <h2 class="article-title">${article.title}</h2>
                    <div class="article-date">${article.date}</div>
                </div>
            `;
            
            // 管理者セクションの後に挿入
            const adminSection = document.querySelector('.admin-section');
            if (adminSection) {
                adminSection.parentNode.insertBefore(newArticleCard, adminSection.nextSibling);
            } else {
                homeScreen.appendChild(newArticleCard);
            }
        }
        
        // 投稿記事数を更新
        function updateArticleCount() {
            const articleCountEl = document.querySelector('.stat-card .stat-number');
            if (articleCountEl) {
                const currentCount = Object.keys(articles).length;
                articleCountEl.textContent = currentCount;
            }
        }

        // 音声プレーヤー関連
        function toggleMainAudio() {
    const audio = document.getElementById('mainAudio');
    const playBtn = document.getElementById('mainPlayBtn');
    const imagePlayBtn = document.querySelector('.play-button');
    
    if (audio.paused) {
        audio.play().catch(e => {
            console.log('音声ファイルが見つかりません:', e);
            if (currentUser.role === 'admin') {
                alert('音声ファイルが見つかりません。kainal_radio_001.mp3 などのファイルをHTMLファイルと同じフォルダに配置してください。');
            } else {
                alert('音声の読み込み中です。しばらくお待ちください。');
            }
        });
        
        // 再生開始時に再生数をカウント
        if (currentArticleId && audio.currentTime === 0) {
            incrementPlayCount(currentArticleId);
        }
        
        playBtn.textContent = '⏸';
        imagePlayBtn.textContent = '⏸';
    } else {
        audio.pause();
        playBtn.textContent = '▶';
        imagePlayBtn.textContent = '▶';
    }
}

        function updateProgress() {
            const audio = document.getElementById('mainAudio');
            const progressBar = document.getElementById('progressBar');
            const currentTimeSpan = document.getElementById('currentTime');
            
            if (audio.duration) {
                const percentage = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = percentage + '%';
            }
            
            currentTimeSpan.textContent = formatTime(audio.currentTime);
        }

        function updateDuration() {
            const audio = document.getElementById('mainAudio');
            const totalTimeSpan = document.getElementById('totalTime');
            
            if (audio.duration) {
                totalTimeSpan.textContent = formatTime(audio.duration);
            }
        }

        function seekAudio(event) {
            const audio = document.getElementById('mainAudio');
            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            audio.currentTime = percentage * audio.duration;
        }

        function audioEnded() {
            const playBtn = document.getElementById('mainPlayBtn');
            const imagePlayBtn = document.querySelector('.play-button');
            playBtn.textContent = '▶';
            imagePlayBtn.textContent = '▶';
        }

function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 現在の音声再生速度を追跡
        let currentPlaybackRate = 1.0;

        // 音声再生速度変更関数
        function changeSpeed(speed) {
            const audio = document.getElementById('mainAudio');
            audio.playbackRate = speed;
            currentPlaybackRate = speed;
            
            // アクティブなボタンの更新
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // クリックされたボタンをアクティブに
            event.target.classList.add('active');
            
            // 通知表示
            showNotification(`🎵 再生速度: ${speed}x`);
        }

// お気に入り機能
function getFavorites() {
            if (!currentUser || !currentUser.userId) return [];
            const favorites = localStorage.getItem(`kainal_favorites_${currentUser.userId}`);
            return favorites ? JSON.parse(favorites) : [];
        }

        function saveFavorites(favorites) {
            localStorage.setItem(`kainal_favorites_${currentUser.userId}`, JSON.stringify(favorites));
        }

        function addToFavorites(articleId) {
            const favorites = getFavorites();
            if (!favorites.includes(articleId)) {
                favorites.push(articleId);
                saveFavorites(favorites);
                showNotification('お気に入りに追加しました！');
            }
        }

        function removeFromFavorites(articleId) {
            const favorites = getFavorites();
            const index = favorites.indexOf(articleId);
            if (index > -1) {
                favorites.splice(index, 1);
                saveFavorites(favorites);
                showNotification('お気に入りから削除しました');
            }
        }

        function isFavorite(articleId) {
            return getFavorites().includes(articleId);
        }

        function toggleCardFavorite(articleId, btn) {
            if (isFavorite(articleId)) {
                removeFromFavorites(articleId);
                btn.textContent = '☆';
                btn.classList.remove('active');
            } else {
                addToFavorites(articleId);
                btn.textContent = '★';
                btn.classList.add('active');
            }
            updateFavoritesList();
        }

        function toggleDetailFavorite() {
            if (!currentArticleId) return;
            
            const starBtn = document.getElementById('detailFavoriteStar');
            const contentBtn = document.getElementById('contentFavoriteBtn');
            
            if (isFavorite(currentArticleId)) {
                removeFromFavorites(currentArticleId);
                starBtn.textContent = '☆';
                starBtn.classList.remove('active');
                contentBtn.textContent = '☆';
                contentBtn.classList.remove('active');
            } else {
                addToFavorites(currentArticleId);
                starBtn.textContent = '★';
                starBtn.classList.add('active');
                contentBtn.textContent = '★';
                contentBtn.classList.add('active');
            }
            
            updateHomeFavoriteButtons();
            updateFavoritesList();
        }

          function updateHomeFavoriteButtons() {
            if (!currentUser) return;
            const cardButtons = document.querySelectorAll('.card-favorite-btn');
            cardButtons.forEach((btn, index) => {
                const articleId = index + 1;
                if (isFavorite(articleId)) {
                    btn.textContent = '★';
                    btn.classList.add('active');
                } else {
                    btn.textContent = '☆';
                    btn.classList.remove('active');
                }
            });
        }

            function updateFavoritesList() {
            if (!currentUser) return;
            const favoritesList = document.getElementById('favoritesList');
            if (!favoritesList) return;
            const favorites = getFavorites();
            
            if (favorites.length === 0) {
                favoritesList.innerHTML = `
                    <div class="empty-message">
                        <div class="empty-message-icon">🌊</div>
                        <p>お気に入りに追加した記事がここに表示されます</p>
                    </div>
                `;
                return;
            }
            
            favoritesList.innerHTML = '';
            favorites.forEach(articleId => {
                const article = articles[articleId];
                if (article) {
                    const favoriteCard = document.createElement('div');
                    favoriteCard.className = 'favorite-card';
                    favoriteCard.onclick = () => showArticle(articleId);
                    
                    favoriteCard.innerHTML = `
                        <div class="favorite-card-content">
                            <div class="favorite-card-image" style="background-image: url('${article.image}');"></div>
                            <div class="favorite-card-info">
                                <div class="favorite-card-title">${article.title}</div>
                                <div class="favorite-card-date">${article.date}</div>
                            </div>
                            <button class="remove-favorite-btn" onclick="event.stopPropagation(); removeFavoriteFromList(${articleId})">×</button>
                        </div>
                    `;
                    
                    favoritesList.appendChild(favoriteCard);
                }
            });
        }

        function removeFavoriteFromList(articleId) {
            removeFromFavorites(articleId);
            updateFavoritesList();
            updateHomeFavoriteButtons();
            
            if (currentArticleId === articleId) {
                const starBtn = document.getElementById('detailFavoriteStar');
                const contentBtn = document.getElementById('contentFavoriteBtn');
                starBtn.textContent = '☆';
                starBtn.classList.remove('active');
                contentBtn.textContent = '☆';
                contentBtn.classList.remove('active');
            }
        }

        // 画面切り替え
function showHome() {
    stopCustomerTemplateCheck();
    hideAllScreens();
    document.getElementById('homeScreen').classList.remove('hidden');
    setActiveNavItem(1);
    
    // テンプレートカードを非表示
    const templatesGrid = document.getElementById('templatesGrid');
    if (templatesGrid) {
        templatesGrid.style.display = 'none';
    }
    
    // 底部ナビゲーションを確実に表示
    ensureBottomNavVisible();
}
    
    // ホーム画面の内容を更新
    updateHomeFavoriteButtons();


function showFavorites() {
    // テンプレートの定期チェックを停止
    stopCustomerTemplateCheck();
    
    hideAllScreens();
    document.getElementById('favoritesScreen').classList.remove('hidden');
    document.getElementById('favoritesScreen').style.display = 'block';
    document.getElementById('favoritesScreen').style.visibility = 'visible';
    updateFavoritesList();
    setActiveNavItem(2);
    
    // テンプレート関連要素を完全に非表示
    const templateAddSection = document.querySelector('.template-add-section');
    if (templateAddSection) {
        templateAddSection.style.display = 'none';
        templateAddSection.style.visibility = 'hidden';
    }
    
    // テンプレートグリッドを非表示
    const templatesGrid = document.getElementById('templatesGrid');
    if (templatesGrid) {
        templatesGrid.style.display = 'none';
        templatesGrid.style.visibility = 'hidden';
    }
    
    // 管理者用テンプレート管理セクションを非表示
    const adminSelectSection = document.getElementById('adminMemberSelectSection');
    if (adminSelectSection) {
        adminSelectSection.style.display = 'none';
        adminSelectSection.style.visibility = 'hidden';
    }
    
    // 会員用テンプレートヘッダーを非表示
    const customerHeader = document.getElementById('customerTemplateHeader');
    if (customerHeader) {
        customerHeader.style.display = 'none';
        customerHeader.style.visibility = 'hidden';
    }
    
    // 底部ナビゲーションを確実に表示
    ensureBottomNavVisible();
}

function showMenu() {
    stopCustomerTemplateCheck();
    hideAllScreens();
    document.getElementById('menuScreen').classList.remove('hidden');
    setActiveNavItem(3);
    
    // テンプレートカードを非表示
    const templatesGrid = document.getElementById('templatesGrid');
    if (templatesGrid) {
        templatesGrid.style.display = 'none';
    }
    // 会員の場合はテンプレート追加ボタンを完全に非表示
    if (currentUser && currentUser.role === 'customer') {
        const templateAddSection = document.querySelector('.template-add-section');
        if (templateAddSection) {
            templateAddSection.style.display = 'none';
            templateAddSection.style.visibility = 'hidden';
        }
    }
    
    // 底部ナビゲーションを確実に表示
    ensureBottomNavVisible();
}

function hideAllScreens() {
    // テンプレート定期チェックを停止
    stopCustomerTemplateCheck();
    
    // 全画面を非表示
    document.getElementById('homeScreen').classList.add('hidden');
    document.getElementById('articleDetail').classList.add('hidden');
    document.getElementById('favoritesScreen').classList.add('hidden');
    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('membersScreen').classList.add('hidden');
    document.getElementById('templatesScreen').classList.add('hidden');
    
    // 分析画面も非表示
    const analyticsScreen = document.getElementById('analyticsScreen');
    if (analyticsScreen) {
        analyticsScreen.classList.add('hidden');
    }
    
    // 管理者用テンプレート管理セクションを非表示
    const adminSelectSection = document.getElementById('adminMemberSelectSection');
    if (adminSelectSection) {
        adminSelectSection.style.display = 'none';
    }
    
    // 会員用テンプレートヘッダーも非表示
    const customerHeader = document.getElementById('customerTemplateHeader');
    if (customerHeader) {
        customerHeader.style.display = 'none';
    }
    
    // テンプレート追加ボタンを会員には表示しない
    if (currentUser && currentUser.role === 'customer') {
        const templateAddSection = document.querySelector('.template-add-section');
        if (templateAddSection) {
            templateAddSection.style.display = 'none';
            templateAddSection.style.visibility = 'hidden';
        }
    }
// テンプレート関連要素をすべて非表示（追加部分）
    const templateElements = [
        '.template-add-section',
        '#templatesGrid',
        '#adminMemberSelectSection', 
        '#customerTemplateHeader'
    ];
    
    templateElements.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.style.display = 'none';
            element.style.visibility = 'hidden';
        }
    });
}

        function setActiveNavItem(index) {
    document.querySelectorAll('.nav-item').forEach((item, i) => {
        item.classList.remove('active');
        if (i === index) {
            item.classList.add('active');
        }
    });
    
    // 確実にアクティブ状態を反映
    setTimeout(() => {
        document.querySelectorAll('.nav-item').forEach((item, i) => {
            if (i === index) {
                item.classList.add('active');
            }
        });
    }, 100);
}

function showArticle(articleId) {
            currentArticleId = articleId;
            const article = articles[articleId];
            if (article) {
                const audio = document.getElementById('mainAudio');
                audio.pause();
                audio.currentTime = 0;
                
                document.getElementById('detailTitle').textContent = article.title;
                document.getElementById('detailDate').textContent = article.date;
                document.getElementById('detailSubtitle').textContent = article.date;
                document.getElementById('detailImage').style.backgroundImage = `url('${article.image}')`;
                document.getElementById('detailText').innerHTML = article.content;
                
                document.getElementById('audioSource').src = article.audioFile;
                audio.load();
                
                // 再生速度を現在の設定に戻す
                audio.playbackRate = currentPlaybackRate;
                
                document.getElementById('mainPlayBtn').textContent = '▶';
                document.querySelector('.play-button').textContent = '▶';
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('currentTime').textContent = '00:00';
                document.getElementById('totalTime').textContent = '--:--';
                
                const starBtn = document.getElementById('detailFavoriteStar');
                const contentBtn = document.getElementById('contentFavoriteBtn');
                if (isFavorite(articleId)) {
                    starBtn.textContent = '★';
                    starBtn.classList.add('active');
                    contentBtn.textContent = '★';
                    contentBtn.classList.add('active');
                } else {
                    starBtn.textContent = '☆';
                    starBtn.classList.remove('active');
                    contentBtn.textContent = '☆';
                    contentBtn.classList.remove('active');
                }
                
                hideAllScreens();
                document.getElementById('articleDetail').classList.remove('hidden');
            }
        }

        function setRating(rating) {
            const stars = document.querySelectorAll('.star-rating .star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                    star.textContent = '★';
                } else {
                    star.classList.remove('active');
                    star.textContent = '☆';
                }
            });
        }

        function submitFeedback() {
    const feedback = document.querySelector('.feedback-input').value;
    const rating = document.querySelectorAll('.star-rating .star.active').length;
    
    if (rating > 0 || feedback.trim()) {
        // 評価データを保存
        if (currentArticleId) {
            saveRatingData(currentArticleId, rating, feedback.trim());
        }
        
        if (currentUser.role === 'admin') {
            alert(`🌊 フィードバックを受信しました！\n\n送信者: ${currentUser.name}\n評価: ${rating}★\n感想: ${feedback || '(なし)'}\n\n※管理者には詳細が表示されます`);
        } else {
            alert('🌊 フィードバックを送信しました！海のような深い感想をありがとうございます。');
        }
        document.querySelector('.feedback-input').value = '';
        document.querySelectorAll('.star-rating .star').forEach(star => {
            star.classList.remove('active');
            star.textContent = '☆';
        });
    } else {
        alert('評価または感想を入力してください。');
    }
}
function showTemplates() {
    hideAllScreens();
    document.getElementById('templatesScreen').classList.remove('hidden');
    setActiveNavItem(0);
    
    // テンプレートカードを表示
    const templatesGrid = document.getElementById('templatesGrid');
    if (templatesGrid) {
        templatesGrid.style.display = 'grid';
    }
    
    // 底部ナビゲーションを確実に表示
    ensureBottomNavVisible();
    
    // 管理者と会員で異なる表示
    if (currentUser.role === 'admin') {
        loadMemberSelectOptions();
        showAdminTemplateView();
    } else {
        showCustomerTemplateView();
        startCustomerTemplateCheck(); // 会員の場合は定期チェック開始
    }
    loadTemplates();
}

// ここから追加 ↓↓↓

// 会員用の定期チェック機能（グローバルスコープに配置）
let customerTemplateInterval = null;

// 会員テンプレートの定期チェックを開始
function startCustomerTemplateCheck() {
    // 既存のインターバルがあれば停止
    if (customerTemplateInterval) {
        clearInterval(customerTemplateInterval);
    }
    
    // 会員のみ定期チェックを開始
    if (currentUser.role === 'customer') {
        customerTemplateInterval = setInterval(() => {
            // テンプレート画面が表示されている場合のみチェック
            if (!document.getElementById('templatesScreen').classList.contains('hidden')) {
                loadTemplates();
            }
        }, 5000); // 5秒ごとにチェック
    }
}

// 定期チェックを停止
function stopCustomerTemplateCheck() {
    if (customerTemplateInterval) {
        clearInterval(customerTemplateInterval);
        customerTemplateInterval = null;
    }
}

// ここまで追加 ↑↑↑
// 管理者用テンプレート表示
function showAdminTemplateView() {
    // ホーム画面のコンテンツを完全に隠す
    document.getElementById('homeScreen').classList.add('hidden');
    
    // 管理者専用のテンプレート追加ボタンを表示
    const templateAddSection = document.querySelector('.template-add-section');
    if (templateAddSection) {
        templateAddSection.style.display = 'flex';
        templateAddSection.style.visibility = 'visible';
    }
    
    // 会員用のヘッダーを非表示
    const customerHeader = document.getElementById('customerTemplateHeader');
    if (customerHeader) {
        customerHeader.style.display = 'none';
    }
    
    // 管理者用の会員選択セクションを表示
    showAdminMemberSelectSection();
}
// 管理者用会員選択セクションを表示
function showAdminMemberSelectSection() {
    let adminSelectSection = document.getElementById('adminMemberSelectSection');
    
    if (!adminSelectSection) {
        adminSelectSection = document.createElement('div');
        adminSelectSection.id = 'adminMemberSelectSection';
        adminSelectSection.style.cssText = 'background: white; padding: 20px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);';
        
        adminSelectSection.innerHTML = `
            <h4 style="color: #f57c00; margin-bottom: 16px; font-size: 18px;">👥 会員のテンプレート管理</h4>
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">🔍 会員を検索</label>
                <input type="text" id="adminMemberSearch" placeholder="会員名またはIDで検索..." onkeyup="filterAdminMembers()" style="width: 100%; padding: 12px; border: 2px solid #e3f2fd; border-radius: 8px; font-size: 16px; margin-bottom: 8px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">👤 管理する会員</label>
                <select id="adminMemberSelect" onchange="loadMemberTemplatesForAdmin()" style="width: 100%; padding: 12px; border: 2px solid #e3f2fd; border-radius: 8px; font-size: 16px;">
                    <option value="">会員を選択してください</option>
                </select>
            </div>
            <div id="selectedMemberInfo" style="margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 8px; display: none;">
                <strong>選択中：</strong> <span id="selectedMemberName"></span>
            </div>
        `;
        
        // テンプレート画面内にのみ追加
        const templatesScreen = document.getElementById('templatesScreen');
        const templatesGrid = document.getElementById('templatesGrid');
        templatesGrid.parentNode.insertBefore(adminSelectSection, templatesGrid);
    }
    
    // テンプレート画面でのみ表示
    const currentScreen = document.getElementById('templatesScreen');
    if (!currentScreen.classList.contains('hidden')) {
        adminSelectSection.style.display = 'block';
    } else {
        adminSelectSection.style.display = 'none';
    }
    
    loadAdminMemberOptions();
}

// 管理者用会員選択オプションを読み込み
function loadAdminMemberOptions() {
    const memberSelect = document.getElementById('adminMemberSelect');
    
    let options = '<option value="">会員を選択してください</option>';
    Object.keys(validUsers).forEach(userId => {
        const user = validUsers[userId];
        if (user.role === 'customer') {
            options += `<option value="${userId}">${user.name} (${user.loginId})</option>`;
        }
    });
    
    memberSelect.innerHTML = options;
    memberSelect.dataset.originalOptions = options;
}

// 管理者用会員検索機能
function filterAdminMembers() {
    const searchInput = document.getElementById('adminMemberSearch');
    const memberSelect = document.getElementById('adminMemberSelect');
    const searchTerm = searchInput.value.toLowerCase();
    
    if (!memberSelect.dataset.originalOptions) {
        memberSelect.dataset.originalOptions = memberSelect.innerHTML;
    }
    
    if (searchTerm === '') {
        memberSelect.innerHTML = memberSelect.dataset.originalOptions;
        return;
    }
    
    let filteredOptions = '<option value="">会員を選択してください</option>';
    Object.keys(validUsers).forEach(userId => {
        const user = validUsers[userId];
        if (user.role === 'customer') {
            const userName = user.name.toLowerCase();
            const userLoginId = user.loginId.toLowerCase();
            
            if (userName.includes(searchTerm) || userLoginId.includes(searchTerm)) {
                filteredOptions += `<option value="${userId}">${user.name} (${user.loginId})</option>`;
            }
        }
    });
    
    memberSelect.innerHTML = filteredOptions;
}

// 管理者が選択した会員のテンプレートを読み込み
function loadMemberTemplatesForAdmin() {
    const memberSelect = document.getElementById('adminMemberSelect');
    const selectedUserId = memberSelect.value;
    const selectedMemberInfo = document.getElementById('selectedMemberInfo');
    const selectedMemberName = document.getElementById('selectedMemberName');
    
    if (selectedUserId) {
        currentSelectedMember = selectedUserId;
        const user = validUsers[selectedUserId];
        selectedMemberName.textContent = `${user.name} (${user.loginId})`;
        selectedMemberInfo.style.display = 'block';
        loadTemplates();
    } else {
        currentSelectedMember = '';
        selectedMemberInfo.style.display = 'none';
        loadTemplates();
    }
}

        // 会員用テンプレート表示
        function showCustomerTemplateView() {
    console.log('showCustomerTemplateView開始');
    console.log('現在のユーザー:', currentUser.userId);
    
    // ホーム画面のコンテンツを完全に隠す
    document.getElementById('homeScreen').classList.add('hidden');
    
    // 管理者専用のテンプレート追加ボタンを完全に非表示にする
    const templateAddSection = document.querySelector('.template-add-section');
    if (templateAddSection) {
        templateAddSection.style.display = 'none';
        templateAddSection.style.visibility = 'hidden';
    }
    
    // 会員選択セクションを非表示
    const memberSelectSection = document.getElementById('memberSelectSection');
    if (memberSelectSection) {
        memberSelectSection.style.display = 'none';
    }
    
    // 管理者用会員選択セクションを非表示
    const adminSelectSection = document.getElementById('adminMemberSelectSection');
    if (adminSelectSection) {
        adminSelectSection.style.display = 'none';
    }
    
    // 管理者用のヘッダーを非表示
    const adminHeader = document.getElementById('adminTemplateHeader');
    if (adminHeader) {
        adminHeader.style.display = 'none';
    }
    
    // 会員用のヘッダーメッセージを表示
    let customerHeader = document.getElementById('customerTemplateHeader');
    if (!customerHeader) {
        customerHeader = document.createElement('div');
        customerHeader.id = 'customerTemplateHeader';
        customerHeader.style.cssText = 'background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 24px; border-radius: 20px; margin-bottom: 24px; text-align: center;';
        customerHeader.innerHTML = `
            <h3 style="color: #1976d2; margin-bottom: 12px; font-size: 20px;">📁 あなたのテンプレート</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 16px;">管理者から提供されたCanvaテンプレート一覧です</p>
            <button onclick="forceRefreshTemplates()" style="background: #1976d2; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px;">🔄 リフレッシュ</button>
        `;
        
        const templatesGrid = document.getElementById('templatesGrid');
        templatesGrid.parentNode.insertBefore(customerHeader, templatesGrid);
    }
    customerHeader.style.display = 'block';
    
    // 強制的にテンプレートを読み込み
    console.log('強制テンプレート読み込み開始');
    forceRefreshTemplates();
}
        function loadMemberSelectOptions() {
            const memberSelect = document.getElementById('memberSelect');
            const modalMemberSelect = document.getElementById('modalMemberSelect');
            
            // 管理者の場合のみ会員選択を表示
            if (currentUser.role === 'admin') {
                let options = '<option value="">会員を選択してください</option>';
                Object.keys(validUsers).forEach(userId => {
                    const user = validUsers[userId];
                    if (user.role === 'customer') {
                        options += `<option value="${userId}">${user.name} (${user.loginId})</option>`;
                    }
                });
                if (memberSelect) {
                    memberSelect.innerHTML = options;
                    memberSelect.dataset.originalOptions = options; // 元のオプションを保存
                }
                if (modalMemberSelect) {
                    modalMemberSelect.innerHTML = options;
                    modalMemberSelect.dataset.originalOptions = options; // 元のオプションを保存
                }
                
                // 検索フィールドをクリア
                const searchInput = document.getElementById('modalMemberSearch');
                if (searchInput) searchInput.value = '';
                const memberSearchInput = document.getElementById('memberSearch');
                if (memberSearchInput) memberSearchInput.value = '';
            }
        }

       function loadMemberTemplates() {
            const memberSelect = document.getElementById('memberSelect');
            currentSelectedMember = memberSelect.value;
            loadTemplates();
        }

        
        function loadMemberTemplates() {
            const memberSelect = document.getElementById('memberSelect');
            currentSelectedMember = memberSelect.value;
            loadTemplates();
        }

       // 会員検索機能
        function filterMembersForTemplate() {
            const searchInput = document.getElementById('memberSearch');
            const memberSelect = document.getElementById('memberSelect');
            const searchTerm = searchInput.value.toLowerCase();
            
            // 元のオプションを保存（初回のみ）
            if (!memberSelect.dataset.originalOptions) {
                memberSelect.dataset.originalOptions = memberSelect.innerHTML;
            }
            
            // 検索文字列が空の場合は全て表示
            if (searchTerm === '') {
                memberSelect.innerHTML = memberSelect.dataset.originalOptions;
                return;
            }
            
            // 検索にマッチする会員を絞り込み
            let filteredOptions = '<option value="">会員を選択してください</option>';
            Object.keys(validUsers).forEach(userId => {
                const user = validUsers[userId];
                if (user.role === 'customer') {
                    const userName = user.name.toLowerCase();
                    const userLoginId = user.loginId.toLowerCase();
                    
                    if (userName.includes(searchTerm) || userLoginId.includes(searchTerm)) {
                        filteredOptions += `<option value="${userId}">${user.name} (${user.loginId})</option>`;
                    }
                }
            });
            
            memberSelect.innerHTML = filteredOptions;
        }

        // モーダル用会員検索機能
        function filterModalMembers() {
            const searchInput = document.getElementById('modalMemberSearch');
            const memberSelect = document.getElementById('modalMemberSelect');
            const searchTerm = searchInput.value.toLowerCase();
            
            // 元のオプションを保存（初回のみ）
            if (!memberSelect.dataset.originalOptions) {
                memberSelect.dataset.originalOptions = memberSelect.innerHTML;
            }
            
            // 検索文字列が空の場合は全て表示
            if (searchTerm === '') {
                memberSelect.innerHTML = memberSelect.dataset.originalOptions;
                return;
            }
            
            // 検索にマッチする会員を絞り込み
            let filteredOptions = '<option value="">会員を選択してください</option>';
            Object.keys(validUsers).forEach(userId => {
                const user = validUsers[userId];
                if (user.role === 'customer') {
                    const userName = user.name.toLowerCase();
                    const userLoginId = user.loginId.toLowerCase();
                    
                    if (userName.includes(searchTerm) || userLoginId.includes(searchTerm)) {
                        filteredOptions += `<option value="${userId}">${user.name} (${user.loginId})</option>`;
                    }
                }
            });
            
            memberSelect.innerHTML = filteredOptions;
        }
                // モーダル用会員検索機能
        function loadTemplates() {
    const templatesGrid = document.getElementById('templatesGrid');
    const emptyTemplates = document.getElementById('emptyTemplates');
    
    // 表示対象のテンプレートを取得
    let displayTemplates = {};
    
    if (currentUser.role === 'admin' && currentSelectedMember) {
        // 管理者：選択された会員のテンプレート
        displayTemplates = getUserTemplates(currentSelectedMember);
        console.log('管理者モード - 選択された会員:', currentSelectedMember);
    } else if (currentUser.role === 'customer') {
        // 会員：自分のテンプレート
        displayTemplates = getUserTemplates(currentUser.userId);
        console.log('会員モード - 自分のテンプレート:', currentUser.userId);
    } else if (currentUser.role === 'admin') {
        // 管理者で会員が選択されていない場合は空表示
        displayTemplates = {};
        console.log('管理者モード - 会員未選択');
    }
    
    console.log('取得されたテンプレート:', displayTemplates);
    console.log('テンプレート数:', Object.keys(displayTemplates).length);
            
            const templateIds = Object.keys(displayTemplates);
            if (templateIds.length === 0) {
                templatesGrid.classList.add('hidden');
                emptyTemplates.classList.remove('hidden');
                
                // 管理者と会員で異なるメッセージを表示
                if (currentUser.role === 'customer') {
                    emptyTemplates.innerHTML = `
                        <div class="empty-icon">📁</div>
                        <h3>テンプレートがありません</h3>
                        <p>管理者からテンプレートが提供されると、ここに表示されます。</p>
                    `;
                } else if (currentUser.role === 'admin') {
                    emptyTemplates.innerHTML = `
    <div class="empty-icon">🔧</div>
    <h3>管理対象を選択してください</h3>
    <p>上の「テンプレートを追加」ボタンから<br>会員を選択してテンプレートを管理できます。</p>
`;
                }
                return;
            }
            
            templatesGrid.classList.remove('hidden');
            emptyTemplates.classList.add('hidden');
            templatesGrid.innerHTML = '';
            
            // 新しいテンプレートが上位に表示されるようにソート
const sortedTemplateIds = templateIds.sort((a, b) => {
    const templateA = displayTemplates[a];
    const templateB = displayTemplates[b];
    // sortOrderが大きい順（新しい順）にソート
    return (templateB.sortOrder || 0) - (templateA.sortOrder || 0);
});

sortedTemplateIds.forEach(templateId => {
    const template = displayTemplates[templateId];
    const templateCard = createTemplateCard(templateId, template);
    templatesGrid.appendChild(templateCard);
});
        }

        function getUserTemplates(userId) {
    const key = `kainal_templates_${userId}`;
    const savedTemplates = localStorage.getItem(key);
    const templates = savedTemplates ? JSON.parse(savedTemplates) : {};
    console.log(`getUserTemplates - Key: ${key}`);
    console.log(`getUserTemplates - Raw data:`, savedTemplates);
    console.log(`getUserTemplates - Parsed templates:`, templates);
    return templates;
}

        function saveUserTemplates(userId, userTemplates) {
    const key = `kainal_templates_${userId}`;
    console.log('テンプレート保存:', key, userTemplates);
    localStorage.setItem(key, JSON.stringify(userTemplates));
    
    // 保存後の確認
    const saved = localStorage.getItem(key);
    console.log('保存確認:', key, JSON.parse(saved));
}

function createTemplateCard(templateId, template) {
    const card = document.createElement('div');
    card.className = 'template-item';
    
    card.innerHTML = `
    <div class="template-thumbnail" onclick="openTemplate('${template.url}')" style="position: relative; overflow: hidden;">
        <img src="${getCanvaImageUrl(template.url)}" 
             alt="${template.title}" 
             style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;"
             onerror="handleImageError(this, '${template.url}')"
             onload="this.style.opacity = '1'"
             style="opacity: 0; transition: opacity 0.3s;">
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: ${getCanvaImageUrl(template.url)}; z-index: 1;"></div>
        <div class="open-overlay" style="z-index: 3;">
            <div class="open-icon">🚀</div>
            <div class="open-text">Canvaで開く</div>
        </div>
    </div>
        <div class="template-info">
            <div class="template-title" onclick="openTemplate('${template.url}')" style="cursor: pointer;">${template.title}</div>
            <div class="template-memo">${template.memo || 'メモなし'}</div>
            
            ${currentUser.role === 'admin' ? `
            <div class="template-actions">
                <button class="template-action-btn edit-template-btn" onclick="event.stopPropagation(); editTemplate('${templateId}')" title="編集">✏️</button>
                <button class="template-action-btn delete-template-btn" onclick="event.stopPropagation(); deleteTemplate('${templateId}')" title="削除">🗑️</button>
            </div>
            ` : ''}
        </div>
    `;
    
    return card;
}

        function openTemplate(url) {
            window.open(url, '_blank');
            showNotification('🖼️ Canvaテンプレートを開きました');
        }



        function showAddTemplateModal() {
            const modal = document.getElementById('addTemplateModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            loadMemberSelectOptions();
            
            // 一般ユーザーの場合は自動選択
            if (currentUser.role === 'customer') {
                document.getElementById('modalMemberSelect').value = currentUser.userId;
            }
        }

        function closeAddTemplateModal() {
            const modal = document.getElementById('addTemplateModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            document.getElementById('addTemplateForm').reset();
        }

        function addNewTemplate() {
            // この関数は使用しないが、エラー回避のため残しておく
            console.log('addNewTemplate is deprecated, use addBulkTemplates instead');
        }

        function editTemplate(templateId) {
            const targetUserId = currentUser.role === 'admin' ? currentSelectedMember : currentUser.userId;
            const userTemplates = getUserTemplates(targetUserId);
            const template = userTemplates[templateId];
            
            if (!template) return;
            
            const newTitle = prompt('テンプレート名を編集:', template.title);
            if (newTitle && newTitle !== template.title) {
                userTemplates[templateId].title = newTitle;
                saveUserTemplates(targetUserId, userTemplates);
                loadTemplates();
                showNotification('✅ テンプレートを更新しました');
            }
        }

        function deleteTemplate(templateId) {
            const targetUserId = currentUser.role === 'admin' ? currentSelectedMember : currentUser.userId;
            const userTemplates = getUserTemplates(targetUserId);
            const template = userTemplates[templateId];
            
            if (!template) return;
            
            if (confirm(`「${template.title}」を削除しますか？`)) {
                delete userTemplates[templateId];
                saveUserTemplates(targetUserId, userTemplates);
                loadTemplates();
                showNotification('🗑️ テンプレートを削除しました');
            }
        }
        // 一括テンプレート追加
        function addBulkTemplates() {
    const urlsText = document.getElementById('bulkTemplateUrls').value.trim();
    
    let targetUserId;
    if (currentUser.role === 'admin') {
        targetUserId = document.getElementById('modalMemberSelect').value;
        if (!targetUserId) {
            alert('追加先の会員を選択してください');
            return;
        }
        console.log('管理者が選択した会員ID:', targetUserId); // デバッグ用
    } else {
        targetUserId = currentUser.userId;
    }
    
    if (!urlsText) {
        alert('URLを入力してください');
        return;
    }
    
    const lines = urlsText.split('\n').filter(line => line.trim());
    const userTemplates = getUserTemplates(targetUserId);
    let addedCount = 0;
    
    console.log('追加前のテンプレート:', userTemplates); // デバッグ用
    
    lines.forEach(line => {
        const trimmedLine = line.trim();
        console.log('処理中の行:', trimmedLine); // デバッグ用
        if (!trimmedLine || trimmedLine.length < 3) {
            console.log('空行またはスキップされた行:', trimmedLine); // デバッグ用
            return;
        }
        
        // URLと説明を分割
        const parts = trimmedLine.split(' ');
        const url = parts[0];
        const description = parts.slice(1).join(' ') || `テンプレート ${addedCount + 1}`;
        
        const templateId = `template_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        userTemplates[templateId] = {
            title: description,
            url: url,
            category: 'テンプレート',
            memo: '管理者から追加されたテンプレート',
            createdAt: new Date().toISOString(),
            createdBy: currentUser.userId
        };
        addedCount++;
        
        console.log('追加されたテンプレート:', templateId, userTemplates[templateId]); // デバッグ用
    });
    
    if (addedCount === 0) {
        alert('有効なURLが見つかりません');
        return;
    }
    
    saveUserTemplates(targetUserId, userTemplates);
    console.log('保存完了。対象会員ID:', targetUserId, '追加されたテンプレート数:', addedCount); // デバッグ用
    
    // UI更新
if (currentUser.role === 'admin') {
    // 管理者画面で選択された会員のテンプレートを表示している場合のみ更新
    if (currentSelectedMember === targetUserId) {
        loadTemplates();
    }
} else if (currentUser.role === 'customer' && currentUser.userId === targetUserId) {
    // 会員本人の場合は即座に更新
    loadTemplates();
}
    
    closeAddTemplateModal();
    showNotification(`✅ ${addedCount}個のテンプレートを${validUsers[targetUserId]?.name || targetUserId}に追加しました！`);
    
    // 確認用：追加後のテンプレートをコンソールで確認
    setTimeout(() => {
        console.log('追加後の確認:', checkUserTemplates(targetUserId));
        
        // 会員が現在ログイン中の場合は強制リフレッシュ
        if (currentUser.userId === targetUserId && currentUser.role === 'customer') {
            refreshCustomerTemplates();
        }
    }, 500);
}
function addBulkTemplatesNew() {
    let targetUserId;
    if (currentUser.role === 'admin') {
        targetUserId = document.getElementById('modalMemberSelect').value;
        if (!targetUserId) {
            alert('追加先の会員を選択してください');
            return;
        }
        console.log('管理者が選択した会員ID:', targetUserId);
        console.log('選択された会員の情報:', validUsers[targetUserId]);
    } else {
        targetUserId = currentUser.userId;
    }
    
    console.log('テンプレート追加対象ユーザーID:', targetUserId);
    
    // 各テンプレート入力行から データを取得
    const templateRows = document.querySelectorAll('.template-input-row');
    const userTemplates = getUserTemplates(targetUserId);
    let addedCount = 0;
    
    console.log('追加前のテンプレート:', userTemplates);
    
    templateRows.forEach((row, index) => {
        const titleInput = row.querySelector('.template-title');
        const urlInput = row.querySelector('.template-url');
        
        const title = titleInput.value.trim();
        const url = urlInput.value.trim();
        
        // タイトルとURLの両方が入力されている場合のみ追加
        if (title && url) {
            console.log(`テンプレート${index + 1} - タイトル:`, title, 'URL:', url);
            
            // タイムスタンプベースのIDを生成
            const timestamp = Date.now() + index; // indexを加えて重複を防ぐ
            const templateId = `template_${timestamp}`;

            userTemplates[templateId] = {
                title: title, // 管理者が入力したタイトル
                url: url,
                category: 'デザインテンプレート',
                memo: `管理者（${currentUser.name}）が追加したテンプレート`,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.userId,
                sortOrder: timestamp
            };
            addedCount++;
            
            console.log('追加されたテンプレート:', templateId, userTemplates[templateId]);
            console.log('現在のuserTemplates:', userTemplates);
            
            // 入力欄をクリア
            titleInput.value = '';
            urlInput.value = '';
        }
    });
    
    if (addedCount === 0) {
        alert('タイトルとURLの両方を入力してください');
        return;
    }
    
    saveUserTemplates(targetUserId, userTemplates);
    console.log('保存完了。対象会員ID:', targetUserId, '追加されたテンプレート数:', addedCount);
    
    // UI更新
    if (currentUser.role === 'admin') {
        if (currentSelectedMember === targetUserId) {
            loadTemplates();
        }
    } else if (currentUser.role === 'customer' && currentUser.userId === targetUserId) {
        loadTemplates();
    }
    
    closeAddTemplateModal();
    showNotification(`✅ ${addedCount}個のテンプレートを${validUsers[targetUserId]?.name || targetUserId}に追加しました！`);
    
    // 確認用：追加後のテンプレートをコンソールで確認
    setTimeout(() => {
        console.log('追加後の確認:', checkUserTemplates(targetUserId));
        
        if (currentUser.userId === targetUserId && currentUser.role === 'customer') {
            refreshCustomerTemplates();
        }
    }, 500);
}

// 次の関数（checkUserTemplates など）

        // デバッグ用：特定会員のテンプレートを確認
        function checkUserTemplates(userId) {
            const templates = getUserTemplates(userId);
            console.log(`会員 ${userId} のテンプレート:`, templates);
            console.log(`テンプレート数: ${Object.keys(templates).length}`);
            return templates;
        }

        // テンプレート表示を強制リフレッシュ
        function refreshTemplateView() {
            if (currentUser.role === 'customer') {
                console.log('会員テンプレート強制リフレッシュ:', currentUser.userId);
                const templates = getUserTemplates(currentUser.userId);
                console.log('取得されたテンプレート:', templates);
                
                const templatesGrid = document.getElementById('templatesGrid');
                const emptyTemplates = document.getElementById('emptyTemplates');
                
                const templateIds = Object.keys(templates);
                if (templateIds.length === 0) {
                    templatesGrid.classList.add('hidden');
                    emptyTemplates.classList.remove('hidden');
                    emptyTemplates.innerHTML = `
                        <div class="empty-icon">📁</div>
                        <h3>テンプレートがありません</h3>
                        <p>管理者からテンプレートが提供されると、ここに表示されます。</p>
                    `;
                } else {
                    templatesGrid.classList.remove('hidden');
                    emptyTemplates.classList.add('hidden');
                    templatesGrid.innerHTML = '';
                    
                    templateIds.forEach(templateId => {
            const template = templates[templateId];
            const templateCard = createTemplateCard(templateId, template);
            templatesGrid.appendChild(templateCard);
        });
    }
}
}

        // 会員専用：テンプレート強制リフレッシュ
        function refreshCustomerTemplates() {
            console.log('会員テンプレート強制リフレッシュ開始:', currentUser.userId);
            const templates = getUserTemplates(currentUser.userId);
            console.log('取得されたテンプレート:', templates);
            
            const templatesGrid = document.getElementById('templatesGrid');
            const emptyTemplates = document.getElementById('emptyTemplates');
            
            const templateIds = Object.keys(templates);
            console.log('テンプレートID一覧:', templateIds);
            
            if (templateIds.length === 0) {
                templatesGrid.classList.add('hidden');
                emptyTemplates.classList.remove('hidden');
                emptyTemplates.innerHTML = `
                    <div class="empty-icon">📁</div>
                    <h3>テンプレートがありません</h3>
                    <p>管理者からテンプレートが提供されると、ここに表示されます。</p>
                    <button onclick="refreshCustomerTemplates()" style="background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 16px;">🔄 再読み込み</button>
                `;
            } else {
                templatesGrid.classList.remove('hidden');
                emptyTemplates.classList.add('hidden');
                templatesGrid.innerHTML = '';
                
                templateIds.forEach(templateId => {
                    const template = templates[templateId];
                    const templateCard = createCustomerTemplateCard(templateId, template);
                    templatesGrid.appendChild(templateCard);
                });
                
                showNotification(`📁 ${templateIds.length}個のテンプレートを表示しました`);
            }
        }

        // 会員専用：直感的なテンプレートカードを作成
        function createCustomerTemplateCard(templateId, template) {
            const card = document.createElement('div');
            card.className = 'template-item';
            card.style.cssText = 'cursor: pointer; transition: all 0.3s; border: 2px solid transparent;';
            
            const imageUrl = getCanvaImageUrl(template.url);
const isGradient = imageUrl.includes('linear-gradient');

card.innerHTML = `
    <div class="template-thumbnail" onclick="openTemplate('${template.url}')" style="position: relative; overflow: hidden; ${isGradient ? `background: ${imageUrl};` : ''}">
        ${!isGradient ? `
            <img src="${imageUrl}" 
                 alt="${template.title}" 
                 style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; transition: opacity 0.3s;"
                 onerror="handleImageError(this, '${template.url}')">
        ` : ''}
        <div class="open-overlay" style="opacity: 0; transition: opacity 0.3s; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(25,118,210,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;">
            <div class="open-icon" style="font-size: 32px; margin-bottom: 8px;">🚀</div>
            <div class="open-text" style="font-size: 14px; font-weight: 600;">クリックして開く</div>
        </div>
    </div>
    <div class="template-info" style="padding: 20px;">
        <div class="template-title" style="font-size: 18px; font-weight: 600; color: #1976d2; margin-bottom: 12px; cursor: pointer; line-height: 1.3;" onclick="openTemplate('${template.url}')">${template.title}</div>
        <div style="font-size: 14px; color: #666; margin-bottom: 16px;">${template.memo || 'テンプレート'}</div>
        
        <div style="display: flex; gap: 8px;">
            <button onclick="openTemplate('${template.url}')" style="flex: 1; background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                🚀 Canvaで開く
            </button>
            <button onclick="copyTemplateUrl('${template.url}')" style="background: #f5f5f5; color: #666; border: none; padding: 12px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                📋
            </button>
        </div>
    </div>
`;
            
            // ホバー効果
            card.addEventListener('mouseenter', function() {
                this.style.borderColor = '#1976d2';
                this.style.transform = 'translateY(-5px)';
                const overlay = this.querySelector('.open-overlay');
                if (overlay) overlay.style.opacity = '1';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.borderColor = 'transparent';
                this.style.transform = 'translateY(0)';
                const overlay = this.querySelector('.open-overlay');
                if (overlay) overlay.style.opacity = '0';
            });
            
            return card;
        }

// 一括追加モーダル


// 一括URL処理

// URLコピー機能
function copyTemplateUrl(url) {
    navigator.clipboard.writeText(url).then(() => {
        showNotification('📋 URLをコピーしました！');
    });
}

// URLハッシュの変更を監視
window.addEventListener('hashchange', function() {
    const hash = window.location.hash;
    
    if (!hash) {
        // ハッシュがクリアされた場合はログアウト
        logout();
        return;
    }
    
    // 現在のユーザーと異なるハッシュの場合は再ログイン促す
    if (currentUser) {
        const expectedHash = currentUser.role === 'admin' ? '#admin' : `#user-${currentUser.userId}`;
        if (hash !== expectedHash) {
            showNotification('⚠️ ユーザーが変更されました。再ログインしてください。');
            logout();
        }
    }
});

// URLハッシュの変更を監視
window.addEventListener('hashchange', function() {
    const hash = window.location.hash;
    
    if (!hash) {
        // ハッシュがクリアされた場合はログアウト
        logout();
        return;
    }
    
    // 現在のユーザーと異なるハッシュの場合は再ログイン促す
    if (currentUser) {
        const expectedHash = currentUser.role === 'admin' ? '#admin' : `#user-${currentUser.userId}`;
        if (hash !== expectedHash) {
            showNotification('⚠️ ユーザーが変更されました。再ログインしてください。');
            logout();
        }
    }
});

// CanvaのURLから画像URLを取得する関数
function getCanvaImageUrl(canvaUrl) {
    try {
        // CanvaのデザインIDを抽出
        const match = canvaUrl.match(/canva\.com\/design\/([^\/\?]+)/);
        if (match) {
            const designId = match[1];
            // Canvaの公開プレビュー画像URL（推測）
            return `https://marketplace-canva-com.s3.amazonaws.com/${designId}/0/thumbnail_large.jpg`;
        }
    } catch (error) {
        console.log('画像URL生成エラー:', error);
    }
    
    // フォールバック：水色系統のグラデーション背景で統一
    return 'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)';
}

// 画像の読み込みエラー時のフォールバック処理
function handleImageError(imgElement, canvaUrl) {
    const fallbackGradient = getCanvaImageUrl(canvaUrl);
    imgElement.style.display = 'none';
    imgElement.parentElement.style.background = fallbackGradient;
}
// 底部ナビゲーションを確実に表示する関数
function ensureBottomNavVisible() {
    const bottomNav = document.getElementById('bottomNav');
    if (bottomNav) {
        bottomNav.classList.remove('hidden');
        bottomNav.style.display = 'flex';
        bottomNav.style.visibility = 'visible';
    }
}
// 強制的に画面遷移を行う関数（エラー処理付き）
function forceNavigateTo(targetFunction) {
    try {
        // 現在の状態をリセット
        stopCustomerTemplateCheck();
        
        // 少し遅延を入れて確実に実行
        setTimeout(() => {
            targetFunction();
        }, 50);
    } catch (error) {
        console.error('画面遷移エラー:', error);
        // エラーが発生した場合はページをリロード
        window.location.reload();
    }
}
// 音声ファイルアップロード関連関数
let uploadedAudioFile = null;

function handleAudioFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
        if (validateAudioFile(file)) {
            uploadedAudioFile = file;
            showUploadedFileName(file.name);
        }
    }
}

function handleAudioDrop(event) {
    event.preventDefault();
    const uploadArea = event.target.closest('.upload-area');
    uploadArea.style.background = '#f8f9fa';
    uploadArea.style.borderColor = '#1976d2';
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (validateAudioFile(file)) {
            uploadedAudioFile = file;
            showUploadedFileName(file.name);
        }
    }
}

function handleAudioDragOver(event) {
    event.preventDefault();
    const uploadArea = event.target.closest('.upload-area');
    uploadArea.style.background = '#e3f2fd';
    uploadArea.style.borderColor = '#42a5f5';
}

function handleAudioDragLeave(event) {
    const uploadArea = event.target.closest('.upload-area');
    uploadArea.style.background = '#f8f9fa';
    uploadArea.style.borderColor = '#1976d2';
}

function validateAudioFile(file) {
    const allowedTypes = ['audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/x-m4a'];
    const maxSize = 50 * 1024 * 1024; // 50MB
    
    if (!allowedTypes.includes(file.type)) {
        alert('❌ 対応していないファイル形式です。MP3、WAV、M4Aファイルを選択してください。');
        return false;
    }
    
    if (file.size > maxSize) {
        alert('❌ ファイルサイズが大きすぎます。50MB以下のファイルを選択してください。');
        return false;
    }
    
    return true;
}

function showUploadedFileName(fileName) {
    document.getElementById('fileName').textContent = `📁 ${fileName}`;
    document.getElementById('uploadedFileName').style.display = 'block';
    showNotification('✅ 音声ファイルがアップロードされました');
}

function removeUploadedFile() {
    uploadedAudioFile = null;
    document.getElementById('uploadedFileName').style.display = 'none';
    document.getElementById('audioFileInput').value = '';
}

// 再生数・評価データ管理
function incrementPlayCount(articleId) {
    if (!currentUser) return;
    
    const playData = getPlayData();
    const today = new Date().toISOString().split('T')[0];
    
    // 記事別再生数
    if (!playData.articles[articleId]) {
        playData.articles[articleId] = { total: 0, daily: {} };
    }
    playData.articles[articleId].total += 1;
    
    if (!playData.articles[articleId].daily[today]) {
        playData.articles[articleId].daily[today] = 0;
    }
    playData.articles[articleId].daily[today] += 1;
    
    // ユーザー別再生履歴
    if (!playData.users[currentUser.userId]) {
        playData.users[currentUser.userId] = [];
    }
    playData.users[currentUser.userId].push({
        articleId: articleId,
        timestamp: new Date().toISOString(),
        title: articles[articleId]?.title || 'Unknown'
    });
    
    savePlayData(playData);
    
    // 管理者の場合は再生数更新通知
    if (currentUser.role === 'admin') {
        console.log(`再生数更新: 記事${articleId} - 総再生数: ${playData.articles[articleId].total}`);
    }
}

function getPlayData() {
    const saved = localStorage.getItem('kainal_play_data');
    return saved ? JSON.parse(saved) : {
        articles: {},
        users: {},
        totalPlays: 0
    };
}

function savePlayData(data) {
    localStorage.setItem('kainal_play_data', JSON.stringify(data));
}

function saveRatingData(articleId, rating, feedback) {
    if (!currentUser) return;
    
    const ratingsData = getRatingsData();
    const ratingId = `rating_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    ratingsData.ratings[ratingId] = {
        articleId: articleId,
        userId: currentUser.userId,
        userName: currentUser.name,
        rating: rating,
        feedback: feedback,
        timestamp: new Date().toISOString()
    };
    
    // 記事別評価統計を更新
    if (!ratingsData.articles[articleId]) {
        ratingsData.articles[articleId] = {
            ratings: [],
            average: 0,
            count: 0
        };
    }
    
    ratingsData.articles[articleId].ratings.push(rating);
    ratingsData.articles[articleId].count = ratingsData.articles[articleId].ratings.length;
    ratingsData.articles[articleId].average = 
        ratingsData.articles[articleId].ratings.reduce((a, b) => a + b, 0) / 
        ratingsData.articles[articleId].count;
    
    localStorage.setItem('kainal_ratings_data', JSON.stringify(ratingsData));
}

function getRatingsData() {
    const saved = localStorage.getItem('kainal_ratings_data');
    return saved ? JSON.parse(saved) : {
        ratings: {},
        articles: {}
    };
}

function viewAnalytics() {
    hideAllScreens();
    showAnalyticsScreen();
    setActiveNavItem(-1);
}

function showAnalyticsScreen() {
    // 分析画面が存在しない場合は作成
    let analyticsScreen = document.getElementById('analyticsScreen');
    if (!analyticsScreen) {
        createAnalyticsScreen();
        analyticsScreen = document.getElementById('analyticsScreen');
    }
    
    analyticsScreen.classList.remove('hidden');
    updateAnalyticsData();
}

function createAnalyticsScreen() {
    const mainApp = document.getElementById('mainApp');
    const analyticsHTML = `
        <div id="analyticsScreen" class="main-content hidden">
            <div class="page-header">
                <button class="back-to-home-btn" onclick="showHome()">🏠</button>
                <div class="page-title">📊 分析データ</div>
            </div>
            
            <!-- 総合統計 -->
            <div class="analytics-overview" style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <h3 style="color: #1976d2; margin-bottom: 20px; text-align: center;">📈 総合統計</h3>
                <div class="analytics-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px;">
                    <div class="analytics-stat-card" style="background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; padding: 16px; border-radius: 12px; text-align: center;">
                        <div class="stat-number" id="totalPlaysCount" style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">0</div>
                        <div class="stat-label" style="font-size: 12px; opacity: 0.9;">総再生数</div>
                    </div>
                    <div class="analytics-stat-card" style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; padding: 16px; border-radius: 12px; text-align: center;">
                        <div class="stat-number" id="avgRatingValue" style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">0.0</div>
                        <div class="stat-label" style="font-size: 12px; opacity: 0.9;">平均評価</div>
                    </div>
                    <div class="analytics-stat-card" style="background: linear-gradient(135deg, #ff9800, #ffb74d); color: white; padding: 16px; border-radius: 12px; text-align: center;">
                        <div class="stat-number" id="totalRatingsCount" style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">0</div>
                        <div class="stat-label" style="font-size: 12px; opacity: 0.9;">評価総数</div>
                    </div>
                </div>
            </div>
            
            <!-- 人気記事ランキング -->
            <div class="popular-articles" style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <h3 style="color: #1976d2; margin-bottom: 20px;">🏆 人気記事ランキング</h3>
                <div id="popularArticlesList"></div>
            </div>
            
            <!-- 記事別詳細データ -->
            <div class="article-details" style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <h3 style="color: #1976d2; margin-bottom: 20px;">📑 記事別詳細データ</h3>
                <div id="articleDetailsList"></div>
            </div>
            
            <!-- 最新の評価・感想 -->
            <div class="recent-feedback" style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 40px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                <h3 style="color: #1976d2; margin-bottom: 20px;">💬 最新の評価・感想</h3>
                <div id="recentFeedbackList"></div>
            </div>
        </div>
    `;
    
    mainApp.insertAdjacentHTML('beforeend', analyticsHTML);
}

function updateAnalyticsData() {
    const playData = getPlayData();
    const ratingsData = getRatingsData();
    
    // 総合統計を更新
    updateOverallStats(playData, ratingsData);
    
    // 人気記事ランキングを更新
    updatePopularArticles(playData, ratingsData);
    
    // 記事別詳細データを更新
    updateArticleDetails(playData, ratingsData);
    
    // 最新の評価・感想を更新
    updateRecentFeedback(ratingsData);
}

function updateOverallStats(playData, ratingsData) {
    // 総再生数
    const totalPlays = Object.values(playData.articles || {})
        .reduce((sum, article) => sum + (article.total || 0), 0);
    document.getElementById('totalPlaysCount').textContent = totalPlays;
    
    // 平均評価
    const allRatings = Object.values(ratingsData.ratings || {}).map(r => r.rating);
    const avgRating = allRatings.length > 0 
        ? (allRatings.reduce((a, b) => a + b, 0) / allRatings.length).toFixed(1)
        : '0.0';
    document.getElementById('avgRatingValue').textContent = avgRating;
    
    // 評価総数
    document.getElementById('totalRatingsCount').textContent = allRatings.length;
}

function updatePopularArticles(playData, ratingsData) {
    const container = document.getElementById('popularArticlesList');
    
    // 記事を再生数でソート
    const articleStats = Object.keys(articles).map(articleId => {
        const playCount = playData.articles[articleId]?.total || 0;
        const articleRating = ratingsData.articles[articleId];
        const avgRating = articleRating ? articleRating.average.toFixed(1) : 'N/A';
        const ratingCount = articleRating ? articleRating.count : 0;
        
        return {
            id: articleId,
            title: articles[articleId].title,
            playCount,
            avgRating,
            ratingCount
        };
    }).sort((a, b) => b.playCount - a.playCount);
    
    container.innerHTML = '';
    articleStats.forEach((article, index) => {
        const rankCard = document.createElement('div');
        rankCard.style.cssText = 'display: flex; align-items: center; padding: 16px; border: 1px solid #e3f2fd; border-radius: 12px; margin-bottom: 12px; background: #fafafa;';
        
        rankCard.innerHTML = `
            <div style="background: ${getRankColor(index)}; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 16px;">
                ${index + 1}
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; color: #1976d2; margin-bottom: 4px;">${article.title}</div>
                <div style="font-size: 14px; color: #666;">
                    👥 ${article.playCount}回再生 | ⭐ ${article.avgRating} (${article.ratingCount}件)
                </div>
            </div>
        `;
        
        container.appendChild(rankCard);
    });
}

function updateArticleDetails(playData, ratingsData) {
    const container = document.getElementById('articleDetailsList');
    container.innerHTML = '';
    
    Object.keys(articles).forEach(articleId => {
        const article = articles[articleId];
        const playCount = playData.articles[articleId]?.total || 0;
        const articleRating = ratingsData.articles[articleId];
        const avgRating = articleRating ? articleRating.average.toFixed(1) : 'N/A';
        const ratingCount = articleRating ? articleRating.count : 0;
        
        const detailCard = document.createElement('div');
        detailCard.style.cssText = 'border: 1px solid #e3f2fd; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: #fafafa;';
        
        detailCard.innerHTML = `
            <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">${article.title}</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; font-size: 14px;">
                <div>📅 ${article.date}</div>
                <div>👥 ${playCount}回再生</div>
                <div>⭐ ${avgRating} (${ratingCount}件)</div>
                <div>💝 お気に入り: ${getFavoriteCount(articleId)}人</div>
            </div>
        `;
        
        container.appendChild(detailCard);
    });
}

function updateRecentFeedback(ratingsData) {
    const container = document.getElementById('recentFeedbackList');
    container.innerHTML = '';
    
    // 最新の評価・感想を取得（最新10件）
    const recentRatings = Object.values(ratingsData.ratings || {})
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 10);
    
    if (recentRatings.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">まだ評価・感想がありません</p>';
        return;
    }
    
    recentRatings.forEach(rating => {
        const feedbackCard = document.createElement('div');
        feedbackCard.style.cssText = 'border: 1px solid #e3f2fd; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: #fafafa;';
        
        const stars = '★'.repeat(rating.rating) + '☆'.repeat(5 - rating.rating);
        const article = articles[rating.articleId];
        const date = new Date(rating.timestamp).toLocaleDateString('ja-JP');
        
        feedbackCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-weight: 600; color: #1976d2;">${rating.userName}</div>
                <div style="font-size: 14px; color: #666;">${date}</div>
            </div>
            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">記事: ${article?.title || 'Unknown'}</div>
            <div style="margin-bottom: 8px; font-size: 18px;">${stars}</div>
            ${rating.feedback ? `<div style="font-size: 14px; line-height: 1.4; color: #444;">"${rating.feedback}"</div>` : ''}
        `;
        
        container.appendChild(feedbackCard);
    });
}

function getRankColor(index) {
    const colors = ['#ffd700', '#c0c0c0', '#cd7f32', '#1976d2', '#42a5f5'];
    return colors[index] || '#42a5f5';
}

function getFavoriteCount(articleId) {
    // 各ユーザーのお気に入りをチェック
    let count = 0;
    Object.keys(validUsers).forEach(userId => {
        const favorites = localStorage.getItem(`kainal_favorites_${userId}`);
        if (favorites) {
            const favList = JSON.parse(favorites);
            if (favList.includes(parseInt(articleId))) {
                count++;
            }
        }
    });
    return count;
}

// Service Worker登録
// 変更後のコード
// Service Worker登録とPWAインストール促進
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('./service-worker.js')
            .then(function(registration) {
                console.log('ServiceWorker登録成功:', registration.scope);
                
                // アップデートがある場合の処理
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            showNotification('🔄 新しいバージョンが利用可能です。ページを更新してください。');
                        }
                    });
                });
            }, function(err) {
                console.log('ServiceWorker登録失敗:', err);
            });
    });
}

// PWAインストール促進
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    console.log('PWAインストールプロンプト準備完了');
    e.preventDefault();
    deferredPrompt = e;
    
    // インストールボタンを表示（任意）
    showInstallButton();
});

window.addEventListener('appinstalled', (evt) => {
    console.log('PWAインストール完了');
    showNotification('🎉 KAINAL Compassがインストールされました！');
});

// インストールボタン表示関数
function showInstallButton() {
    const installBtn = document.createElement('button');
    installBtn.textContent = '📱 アプリをインストール';
    installBtn.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(76,175,80,0.3);
    `;
    
    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`PWAインストール結果: ${outcome}`);
            deferredPrompt = null;
            installBtn.remove();
        }
    });
    
    document.body.appendChild(installBtn);
    
    // 10秒後に自動で非表示
    setTimeout(() => {
        if (document.body.contains(installBtn)) {
            installBtn.remove();
        }
    }, 10000);
}
// 強制テンプレートリフレッシュ関数
function forceRefreshTemplates() {
    console.log('forceRefreshTemplates開始');
    console.log('現在のユーザーID:', currentUser.userId);
    
    const templatesGrid = document.getElementById('templatesGrid');
    const emptyTemplates = document.getElementById('emptyTemplates');
    
    // テンプレートグリッドを確実に表示
    templatesGrid.style.display = 'grid';
    templatesGrid.style.visibility = 'visible';
    templatesGrid.classList.remove('hidden');
    
    // 空メッセージを非表示
    emptyTemplates.style.display = 'none';
    emptyTemplates.classList.add('hidden');
    
    // LocalStorageから直接テンプレートを取得
    const templateKey = `kainal_templates_${currentUser.userId}`;
    const savedTemplates = localStorage.getItem(templateKey);
    console.log('テンプレートキー:', templateKey);
    console.log('保存されたテンプレート:', savedTemplates);
    
    let templates = {};
    if (savedTemplates) {
        try {
            templates = JSON.parse(savedTemplates);
        } catch (e) {
            console.error('テンプレート解析エラー:', e);
            templates = {};
        }
    }
    
    console.log('解析されたテンプレート:', templates);
    const templateIds = Object.keys(templates);
    console.log('テンプレートID一覧:', templateIds);
    
    // グリッドをクリア
    templatesGrid.innerHTML = '';
    
    if (templateIds.length === 0) {
        // テンプレートがない場合
        templatesGrid.style.display = 'none';
        emptyTemplates.style.display = 'block';
        emptyTemplates.classList.remove('hidden');
        emptyTemplates.innerHTML = `
            <div class="empty-icon">📁</div>
            <h3>テンプレートがありません</h3>
            <p>管理者からテンプレートが提供されると、ここに表示されます。</p>
            <button onclick="forceRefreshTemplates()" style="background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 16px;">🔄 再読み込み</button>
        `;
        console.log('テンプレートなし - 空メッセージ表示');
    } else {
        // テンプレートがある場合
        console.log('テンプレートあり - カード作成開始');
        templateIds.forEach(templateId => {
            const template = templates[templateId];
            console.log('カード作成:', templateId, template);
            
            const templateCard = document.createElement('div');
            templateCard.className = 'template-item';
            templateCard.style.cssText = 'cursor: pointer; transition: all 0.3s; border: 2px solid transparent;';
            
            templateCard.innerHTML = `
                <div class="template-thumbnail" onclick="openTemplate('${template.url}')" style="position: relative; overflow: hidden; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); height: 160px; display: flex; align-items: center; justify-content: center; font-size: 48px;">
                    🎨
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(25,118,210,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; opacity: 0; transition: opacity 0.3s;" onmouseenter="this.style.opacity='1'" onmouseleave="this.style.opacity='0'">
                        <div style="font-size: 32px; margin-bottom: 8px;">🚀</div>
                        <div style="font-size: 14px; font-weight: 600;">クリックして開く</div>
                    </div>
                </div>
                <div class="template-info" style="padding: 20px;">
                    <div class="template-title" style="font-size: 18px; font-weight: 600; color: #1976d2; margin-bottom: 12px; cursor: pointer; line-height: 1.3;" onclick="openTemplate('${template.url}')">${template.title}</div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 16px;">${template.memo || 'テンプレート'}</div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openTemplate('${template.url}')" style="flex: 1; background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                            🚀 Canvaで開く
                        </button>
                        <button onclick="copyTemplateUrl('${template.url}')" style="background: #f5f5f5; color: #666; border: none; padding: 12px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                            📋
                        </button>
                    </div>
                </div>
            `;
            
            templatesGrid.appendChild(templateCard);
        });
        
        console.log('テンプレートカード作成完了');
        showNotification(`📁 ${templateIds.length}個のテンプレートを表示しました`);
    }
}

    </script>
</body>
</html>
    </script>
</body>
</html>